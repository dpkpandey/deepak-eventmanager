<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ProjectPulse</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#05050a;--card:#0d0d18;--card2:#111122;
  --border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.13);
  --text:#f0f0ff;--muted:#6060a0;--soft:#9090c0;
  --violet:#7c3aed;--violet2:#a855f7;--indigo:#4f46e5;
  --cyan:#06b6d4;--emerald:#10b981;--amber:#f59e0b;
  --rose:#f43f5e;--orange:#f97316;--sky:#0ea5e9;
  --pink:#ec4899;--lime:#84cc16;--teal:#14b8a6;
  --r:14px;--rsm:8px;--rlg:20px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background:
  radial-gradient(ellipse 80% 50% at 20% 0%,rgba(124,58,237,.12) 0%,transparent 60%),
  radial-gradient(ellipse 60% 40% at 80% 10%,rgba(6,182,212,.08) 0%,transparent 50%),
  radial-gradient(ellipse 50% 60% at 50% 100%,rgba(16,185,129,.06) 0%,transparent 50%);
  pointer-events:none;z-index:0;}
body::after{content:'';position:fixed;inset:0;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events:none;z-index:0;opacity:.35;}

/* HEADER */
header{position:sticky;top:0;z-index:200;background:rgba(5,5,10,.85);backdrop-filter:blur(24px) saturate(180%);border-bottom:1px solid var(--border);padding:0 2.5rem;height:68px;display:flex;align-items:center;justify-content:space-between;}
.logo-wrap{display:flex;align-items:center;gap:.75rem;}
.logo-icon{width:38px;height:38px;border-radius:11px;background:linear-gradient(135deg,var(--violet),var(--cyan));display:flex;align-items:center;justify-content:center;font-size:1.15rem;box-shadow:0 0 22px rgba(124,58,237,.5);}
.logo-text{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;background:linear-gradient(135deg,#fff,var(--violet2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-.02em;}
.hcenter{display:flex;align-items:center;gap:.35rem;background:var(--card);border:1px solid var(--border);border-radius:100px;padding:.3rem;}
.vpill{padding:.35rem 1rem;border-radius:100px;font-size:.78rem;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--muted);transition:all .2s;font-family:'Outfit',sans-serif;}
.vpill.active{background:linear-gradient(135deg,var(--violet),var(--indigo));color:white;box-shadow:0 2px 12px rgba(124,58,237,.4);}
.hright{display:flex;align-items:center;gap:.75rem;}
.date-pill{font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--muted);background:var(--card);border:1px solid var(--border);padding:.3rem .8rem;border-radius:100px;}
.db-btn{display:flex;align-items:center;gap:.4rem;font-size:.72rem;font-weight:600;color:var(--muted);background:var(--card);border:1px solid var(--border);padding:.3rem .8rem;border-radius:100px;cursor:pointer;transition:all .2s;font-family:'Outfit',sans-serif;}
.db-btn:hover{border-color:var(--border2);color:var(--text);}
.db-dot{width:6px;height:6px;border-radius:50%;background:var(--muted);transition:all .3s;}
.db-dot.on{background:var(--emerald);box-shadow:0 0 6px var(--emerald);animation:bpulse 2s infinite;}
.db-dot.sync{background:var(--cyan);box-shadow:0 0 6px var(--cyan);animation:bspin 1s infinite;}
.db-dot.err{background:var(--rose);box-shadow:0 0 6px var(--rose);}
@keyframes bpulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes bspin{0%,100%{transform:scale(1)}50%{transform:scale(1.6)}}
.btn-new{display:flex;align-items:center;gap:.4rem;background:linear-gradient(135deg,var(--violet),var(--violet2));border:none;color:white;padding:.5rem 1.1rem;border-radius:100px;font-family:'Outfit',sans-serif;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .25s;box-shadow:0 4px 15px rgba(124,58,237,.35);}
.btn-new:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(124,58,237,.5);}

/* CONFIG DRAWER */
.config-drawer{position:fixed;top:68px;right:0;width:360px;background:var(--card);border:1px solid var(--border2);border-right:none;border-top:none;border-radius:0 0 0 var(--rlg);padding:1.5rem;z-index:150;transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);box-shadow:-20px 20px 60px rgba(0,0,0,.5);}
.config-drawer.open{transform:translateX(0);}
.cfg-title{font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--violet2);margin-bottom:1rem;}
.cfg-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-bottom:.8rem;}
.flabel{font-size:.64rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:.3rem;display:block;}
input[type=text],input[type=date],textarea,select{background:rgba(255,255,255,.04);border:1px solid var(--border2);color:var(--text);font-family:'Outfit',sans-serif;font-size:.82rem;padding:.55rem .8rem;border-radius:var(--rsm);width:100%;outline:none;transition:border-color .2s,box-shadow .2s;resize:vertical;}
input:focus,textarea:focus,select:focus{border-color:var(--violet);box-shadow:0 0 0 3px rgba(124,58,237,.15);}
.btn-connect{width:100%;background:linear-gradient(135deg,var(--violet),var(--cyan));border:none;color:white;padding:.65rem;border-radius:var(--rsm);font-family:'Outfit',sans-serif;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .2s;margin-top:.3rem;}
.btn-connect:hover{opacity:.9;transform:translateY(-1px);}

/* MAIN */
.main{position:relative;z-index:1;max-width:1300px;margin:0 auto;padding:2rem 2.5rem;}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(5,1fr);gap:1rem;margin-bottom:2.5rem;animation:fadeUp .5s ease both;}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.sc{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:1.3rem 1.5rem;position:relative;overflow:hidden;transition:transform .2s,border-color .2s,box-shadow .2s;cursor:default;}
.sc::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--ga,transparent),var(--gb,transparent));opacity:.07;transition:opacity .2s;}
.sc:hover{transform:translateY(-3px);border-color:var(--border2);box-shadow:0 12px 40px rgba(0,0,0,.4);}
.sc:hover::before{opacity:.13;}
.sc .glow{position:absolute;top:-20px;right:-20px;width:80px;height:80px;border-radius:50%;background:var(--glow,transparent);filter:blur(25px);opacity:.4;}
.slabel{font-size:.64rem;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin-bottom:.5rem;}
.sval{font-family:'Playfair Display',serif;font-size:2.8rem;line-height:1;font-weight:900;background:linear-gradient(135deg,var(--va,#fff),var(--vb,#fff));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.ssub{font-size:.7rem;color:var(--muted);margin-top:.3rem;}

/* FILTER */
.filter-strip{display:flex;align-items:center;gap:.4rem;margin-bottom:1.5rem;flex-wrap:wrap;animation:fadeUp .5s .1s ease both;}
.fchip{padding:.35rem .9rem;border-radius:100px;font-size:.74rem;font-weight:600;cursor:pointer;border:1px solid var(--border2);background:transparent;color:var(--soft);font-family:'Outfit',sans-serif;transition:all .2s;}
.fchip:hover{border-color:var(--border2);color:var(--text);background:var(--card);}
.fchip.active{background:var(--cbg,var(--violet));border-color:transparent;color:white;box-shadow:0 3px 12px var(--csh,rgba(124,58,237,.4));}

/* PROJECTS */
.plist{display:flex;flex-direction:column;gap:1.2rem;animation:fadeUp .5s .15s ease both;}
.pcard{background:var(--card);border:1px solid var(--border);border-radius:var(--rlg);overflow:hidden;transition:border-color .25s,box-shadow .25s,transform .25s;position:relative;}
.pcard::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--pc,var(--violet)),transparent);opacity:.6;}
.pcard:hover{border-color:var(--border2);box-shadow:0 8px 40px rgba(0,0,0,.4);transform:translateY(-2px);}
.phead{padding:1.4rem 1.6rem;display:flex;align-items:center;gap:1.2rem;cursor:pointer;user-select:none;}
.paccent{width:5px;height:52px;border-radius:4px;flex-shrink:0;}
.picon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0;background:linear-gradient(135deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid var(--border2);}
.pinfo{flex:1;min-width:0;}
.pname{font-size:1.05rem;font-weight:700;color:var(--text);margin-bottom:.25rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pmeta{display:flex;align-items:center;gap:.7rem;flex-wrap:wrap;}
.pmi{font-size:.7rem;color:var(--muted);font-family:'JetBrains Mono',monospace;}

/* STATUS BADGE */
.sbadge{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;border-radius:100px;font-size:.63rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;border:1px solid transparent;}
.s-planned{background:rgba(96,96,160,.15);color:var(--soft);border-color:rgba(96,96,160,.3);}
.s-in-progress{background:rgba(14,165,233,.12);color:var(--sky);border-color:rgba(14,165,233,.3);}
.s-review{background:rgba(168,85,247,.12);color:var(--violet2);border-color:rgba(168,85,247,.3);}
.s-pause{background:rgba(245,158,11,.12);color:var(--amber);border-color:rgba(245,158,11,.3);}
.s-blocked{background:rgba(244,63,94,.12);color:var(--rose);border-color:rgba(244,63,94,.3);}
.s-done{background:rgba(16,185,129,.12);color:var(--emerald);border-color:rgba(16,185,129,.3);}
.sdot{width:5px;height:5px;border-radius:50%;background:currentColor;}
.s-in-progress .sdot{animation:bpulse 1.5s infinite;}

/* ARC */
.arcwrap{position:relative;width:54px;height:54px;flex-shrink:0;}
.arcwrap svg{transform:rotate(-90deg);}
.arc-bg{fill:none;stroke:rgba(255,255,255,.06);stroke-width:4;}
.arc-fill{fill:none;stroke-width:4;stroke-linecap:round;transition:stroke-dashoffset .8s cubic-bezier(.4,0,.2,1);}
.arcpct{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-size:.65rem;font-weight:500;color:var(--text);}

.pactions{display:flex;gap:.4rem;flex-shrink:0;}
.ibtn{width:34px;height:34px;border-radius:var(--rsm);border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.85rem;transition:all .2s;}
.ibtn:hover{background:var(--card2);color:var(--text);border-color:var(--border2);}
.ibtn.del:hover{background:rgba(244,63,94,.1);color:var(--rose);border-color:rgba(244,63,94,.3);}
.chev{width:28px;height:28px;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:1rem;transition:transform .3s,color .2s;flex-shrink:0;}
.chev.open{transform:rotate(180deg);color:var(--text);}

/* PROJECT BODY */
.pbody{display:none;padding:0 1.6rem 1.6rem;border-top:1px solid var(--border);}
.pbody.open{display:block;}
.srow{display:flex;align-items:center;justify-content:space-between;margin:1.2rem 0 .75rem;}
.slbl{font-size:.64rem;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);}

/* STATUS PICKER */
.sprow{display:flex;gap:.4rem;flex-wrap:wrap;margin-bottom:1.2rem;padding:1rem;background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:var(--r);}
.sp{padding:.3rem .75rem;border-radius:100px;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;cursor:pointer;border:1.5px solid transparent;transition:all .15s;font-family:'Outfit',sans-serif;}
.sp[data-s=planned]{border-color:rgba(96,96,160,.4);color:var(--soft);}
.sp[data-s=planned].on{background:rgba(96,96,160,.2);color:white;}
.sp[data-s=in-progress]{border-color:rgba(14,165,233,.4);color:var(--sky);}
.sp[data-s=in-progress].on{background:var(--sky);color:#000;}
.sp[data-s=review]{border-color:rgba(168,85,247,.4);color:var(--violet2);}
.sp[data-s=review].on{background:var(--violet2);color:white;}
.sp[data-s=pause]{border-color:rgba(245,158,11,.4);color:var(--amber);}
.sp[data-s=pause].on{background:var(--amber);color:#000;}
.sp[data-s=blocked]{border-color:rgba(244,63,94,.4);color:var(--rose);}
.sp[data-s=blocked].on{background:var(--rose);color:white;}
.sp[data-s=done]{border-color:rgba(16,185,129,.4);color:var(--emerald);}
.sp[data-s=done].on{background:var(--emerald);color:#000;}

/* INFO GRID */
.igrid{display:grid;grid-template-columns:1fr 1fr;gap:.8rem;margin-bottom:1.2rem;}
.iblk{background:rgba(255,255,255,.025);border:1px solid var(--border);border-radius:var(--r);padding:.9rem 1rem;}
.iblk-lbl{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:.5rem;}
.iblk textarea{background:transparent;border:none;padding:0;font-size:.82rem;color:var(--soft);min-height:52px;box-shadow:none;}
.iblk textarea:focus{border:none;box-shadow:none;color:var(--text);}

/* SUBS */
.subslist{display:flex;flex-direction:column;gap:.65rem;}
.subcard{background:rgba(255,255,255,.025);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;transition:border-color .2s;}
.subcard:hover{border-color:var(--border2);}
.subhead{padding:.85rem 1.1rem;display:flex;align-items:center;gap:.8rem;cursor:pointer;}
.subdot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.subinfo{flex:1;min-width:0;}
.subname{font-size:.88rem;font-weight:600;color:var(--text);margin-bottom:.12rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.subprev{font-size:.72rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.subbody{display:none;padding:1rem 1.1rem 1.1rem;border-top:1px solid var(--border);background:rgba(0,0,0,.2);}
.subbody.open{display:block;}

/* SUB FIELDS */
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-bottom:.9rem;}
.sfield{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:var(--rsm);padding:.7rem .8rem;}
.sfield label{font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:.35rem;display:block;}
.sfield textarea{background:transparent;border:none;padding:0;font-size:.78rem;color:var(--soft);min-height:50px;box-shadow:none;}
.sfield textarea:focus{border:none;box-shadow:none;color:var(--text);}

/* TASKS */
.taskwrap{margin-bottom:.9rem;}
.titem{display:flex;align-items:center;gap:.6rem;padding:.45rem .6rem;border-radius:6px;transition:background .15s;}
.titem:hover{background:rgba(255,255,255,.03);}
.tcheck{width:18px;height:18px;border-radius:5px;border:1.5px solid var(--border2);flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.65rem;transition:all .2s;}
.tcheck.done{background:var(--emerald);border-color:var(--emerald);color:#000;}
.ttext{flex:1;font-size:.78rem;color:var(--soft);}
.ttext.done{text-decoration:line-through;color:var(--muted);}
.tdel,.ldel{background:none;border:none;color:transparent;cursor:pointer;font-size:.72rem;padding:.15rem .3rem;border-radius:4px;transition:all .15s;}
.titem:hover .tdel,.lentry:hover .ldel{color:var(--muted);}
.tdel:hover,.ldel:hover{color:var(--rose)!important;background:rgba(244,63,94,.1);}
.addrow{display:flex;gap:.5rem;margin-top:.5rem;}
.addrow input{flex:1;font-size:.78rem;padding:.45rem .7rem;}
.btnadd{background:rgba(124,58,237,.15);border:1px solid rgba(124,58,237,.3);color:var(--violet2);padding:.45rem .8rem;border-radius:var(--rsm);font-size:.75rem;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;white-space:nowrap;transition:all .2s;}
.btnadd:hover{background:rgba(124,58,237,.25);}

/* LOG */
.lentry{display:flex;gap:.7rem;padding:.5rem .6rem;border-radius:6px;transition:background .15s;animation:fadeIn .3s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.lentry:hover{background:rgba(255,255,255,.03);}
.ldate{font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--muted);white-space:nowrap;padding-top:.15rem;min-width:72px;}
.ltext{flex:1;font-size:.78rem;color:var(--soft);line-height:1.5;}
.loginrow{display:flex;gap:.5rem;margin-top:.6rem;align-items:flex-start;}
.loginrow textarea{flex:1;min-height:64px;font-size:.78rem;resize:none;}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(12px);z-index:500;display:flex;align-items:center;justify-content:center;padding:2rem;opacity:0;pointer-events:none;transition:opacity .25s;}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--card);border:1px solid var(--border2);border-radius:var(--rlg);padding:2rem;width:100%;max-width:500px;max-height:88vh;overflow-y:auto;transform:scale(.95) translateY(10px);transition:transform .25s cubic-bezier(.4,0,.2,1);}
.overlay.open .modal{transform:scale(1) translateY(0);}
.mtitle{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:700;margin-bottom:.25rem;background:linear-gradient(135deg,#fff,var(--violet2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.msub{font-size:.78rem;color:var(--muted);margin-bottom:1.5rem;}
.fg{margin-bottom:1.1rem;}
.colorrow{display:flex;gap:.5rem;flex-wrap:wrap;}
.cdot{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2.5px solid transparent;transition:all .15s;outline:2px solid transparent;outline-offset:2px;}
.cdot.sel{outline-color:white;transform:scale(1.15);}
.mfooter{display:flex;justify-content:flex-end;gap:.6rem;margin-top:1.5rem;}
.btnghost{background:transparent;border:1px solid var(--border2);color:var(--muted);padding:.55rem 1.2rem;border-radius:var(--rsm);font-family:'Outfit',sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s;}
.btnghost:hover{color:var(--text);background:var(--card2);}
.btnsave{background:linear-gradient(135deg,var(--violet),var(--violet2));border:none;color:white;padding:.55rem 1.5rem;border-radius:var(--rsm);font-family:'Outfit',sans-serif;font-size:.82rem;font-weight:700;cursor:pointer;transition:all .2s;box-shadow:0 4px 15px rgba(124,58,237,.3);}
.btnsave:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(124,58,237,.45);}

/* REPORT */
.rwrap{background:var(--card);border:1px solid var(--border);border-radius:var(--rlg);overflow:hidden;animation:fadeUp .4s ease both;}
.rtbar{padding:1rem 1.4rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;}
.rout{padding:1.5rem;font-family:'JetBrains Mono',monospace;font-size:.76rem;line-height:1.9;color:var(--soft);white-space:pre-wrap;word-break:break-word;min-height:300px;max-height:600px;overflow-y:auto;}

/* EMPTY */
.empty{text-align:center;padding:6rem 2rem;}
.empty-icon{font-size:4rem;margin-bottom:1rem;opacity:.2;}
.empty-title{font-family:'Playfair Display',serif;font-size:1.6rem;color:var(--text);margin-bottom:.5rem;}
.empty-sub{font-size:.85rem;color:var(--muted);margin-bottom:2rem;}

/* TOAST */
.toasts{position:fixed;bottom:1.5rem;right:1.5rem;z-index:9000;display:flex;flex-direction:column;gap:.5rem;}
.toast{background:var(--card2);border:1px solid var(--border2);color:var(--text);padding:.7rem 1.1rem;border-radius:var(--r);font-size:.8rem;display:flex;align-items:center;gap:.6rem;min-width:200px;box-shadow:0 8px 30px rgba(0,0,0,.4);animation:tin .3s ease,tout .3s 2.7s ease forwards;}
.toast.success{border-color:rgba(16,185,129,.4);}
.toast.error{border-color:rgba(244,63,94,.4);}
.toast.warn{border-color:rgba(245,158,11,.4);}
@keyframes tin{from{transform:translateX(110%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes tout{to{transform:translateX(110%);opacity:0}}

.vp{display:none;}.vp.active{display:block;}
.btnsub{display:flex;align-items:center;gap:.35rem;background:rgba(6,182,212,.08);border:1px solid rgba(6,182,212,.2);color:var(--cyan);padding:.4rem .9rem;border-radius:100px;font-size:.74rem;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;transition:all .2s;}
.btnsub:hover{background:rgba(6,182,212,.15);}

::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}

@media(max-width:768px){
  .stats-row{grid-template-columns:repeat(2,1fr);}
  .igrid,.sgrid{grid-template-columns:1fr;}
  .config-drawer{width:100%;border-radius:0;}
  .hcenter{display:none;}
  header{padding:0 1rem;}
  .main{padding:1rem;}
}
</style>
</head>
<body>

<header>
  <div class="logo-wrap">
    <div class="logo-icon">‚ö°</div>
    <div class="logo-text">ProjectPulse</div>
  </div>
  <div class="hcenter">
    <button class="vpill active" onclick="switchView('projects',this)">üìÅ Projects</button>
    <button class="vpill" onclick="switchView('report',this)">üìä Report</button>
  </div>
  <div class="hright">
    <div class="date-pill" id="datePill"></div>
    <div class="db-btn" onclick="toggleConfig()" title="Database settings">
      <div class="db-dot" id="dbDot"></div>
      <span id="dbLbl">Setup DB</span>
    </div>
    <button class="btn-new" onclick="openModal('project')">+ New Project</button>
  </div>
</header>

<!-- CONFIG DRAWER -->
<div class="config-drawer" id="cfgDrawer">
  <div class="cfg-title">‚òÅ Cloudflare D1 ‚Äî Auto Sync</div>
  <div class="cfg-grid">
    <div><label class="flabel">Worker URL</label><input type="text" id="cfUrl" placeholder="https://your-worker.workers.dev"/></div>
    <div><label class="flabel">API Key</label><input type="text" id="cfKey" placeholder="your-secret-key"/></div>
  </div>
  <button class="btn-connect" onclick="connectDB()">‚ö° Connect ‚Äî Auto Sync Enabled</button>
  <div style="margin-top:.8rem;font-size:.68rem;color:var(--muted);line-height:1.8;">
    ‚úÖ Every change auto-saves to D1 in 2 seconds<br>
    ‚úÖ Page open = loads latest data automatically<br>
    ‚úÖ Works offline with localStorage fallback
  </div>
</div>

<div class="main">

  <!-- STATS -->
  <div class="stats-row">
    <div class="sc" style="--ga:#7c3aed;--gb:#06b6d4;--glow:rgba(124,58,237,.6)"><div class="glow"></div><div class="slabel">Total Projects</div><div class="sval" id="sT" style="--va:#fff;--vb:#a855f7">0</div><div class="ssub" id="sSubs">0 sub-projects</div></div>
    <div class="sc" style="--ga:#0ea5e9;--gb:#06b6d4;--glow:rgba(14,165,233,.6)"><div class="glow"></div><div class="slabel">In Progress</div><div class="sval" id="sP" style="--va:#0ea5e9;--vb:#06b6d4">0</div><div class="ssub">Active now</div></div>
    <div class="sc" style="--ga:#10b981;--gb:#84cc16;--glow:rgba(16,185,129,.6)"><div class="glow"></div><div class="slabel">Completed</div><div class="sval" id="sD" style="--va:#10b981;--vb:#84cc16">0</div><div class="ssub">All done ‚úì</div></div>
    <div class="sc" style="--ga:#f59e0b;--gb:#f97316;--glow:rgba(245,158,11,.6)"><div class="glow"></div><div class="slabel">Paused</div><div class="sval" id="sPa" style="--va:#f59e0b;--vb:#f97316">0</div><div class="ssub">On hold</div></div>
    <div class="sc" style="--ga:#f43f5e;--gb:#ec4899;--glow:rgba(244,63,94,.6)"><div class="glow"></div><div class="slabel">Blocked</div><div class="sval" id="sBl" style="--va:#f43f5e;--vb:#ec4899">0</div><div class="ssub">Need attention</div></div>
  </div>

  <!-- PROJECTS PANEL -->
  <div id="projects-panel" class="vp active">
    <div class="filter-strip">
      <button class="fchip active" style="--cbg:linear-gradient(135deg,#7c3aed,#4f46e5);--csh:rgba(124,58,237,.4)" onclick="doFilter('all',this)">All</button>
      <button class="fchip" style="--cbg:var(--sky);--csh:rgba(14,165,233,.4)" onclick="doFilter('in-progress',this)">üîµ In Progress</button>
      <button class="fchip" style="--cbg:var(--emerald);--csh:rgba(16,185,129,.4)" onclick="doFilter('done',this)">üü¢ Done</button>
      <button class="fchip" style="--cbg:var(--amber);--csh:rgba(245,158,11,.4)" onclick="doFilter('pause',this)">üü° Paused</button>
      <button class="fchip" style="--cbg:var(--rose);--csh:rgba(244,63,94,.4)" onclick="doFilter('blocked',this)">üî¥ Blocked</button>
      <button class="fchip" style="--cbg:var(--violet2);--csh:rgba(168,85,247,.4)" onclick="doFilter('review',this)">üü£ Review</button>
    </div>
    <div class="plist" id="pList"></div>
  </div>

  <!-- REPORT PANEL -->
  <div id="report-panel" class="vp">
    <div class="rwrap">
      <div class="rtbar">
        <button class="btn-new" onclick="genReport()" style="border-radius:var(--rsm)">‚ö° Generate</button>
        <button class="btnghost" onclick="copyReport()">üìã Copy</button>
        <select id="rFmt" style="width:auto;padding:.45rem .8rem;background:var(--card2);border-color:var(--border2);font-size:.78rem">
          <option value="md">Markdown</option>
          <option value="txt">Plain Text</option>
        </select>
        <button class="btnghost" onclick="doExport()">‚¨á Export</button>
        <button class="btnghost" onclick="doImport()">‚¨Ü Import</button>
      </div>
      <div class="rout" id="rOut">Click ‚ö° Generate to create a shareable team status report.</div>
    </div>
  </div>
</div>

<!-- PROJECT MODAL -->
<div class="overlay" id="pModal">
  <div class="modal">
    <div class="mtitle" id="mT">New Project</div>
    <div class="msub" id="mS">Fill in the details to create a new project.</div>
    <div class="fg"><label class="flabel">Project Name *</label><input type="text" id="mPN" placeholder="e.g. Website Redesign"/></div>
    <div class="fg"><label class="flabel">Description</label><textarea id="mPD" rows="2" placeholder="What is this project about?"></textarea></div>
    <div class="fg"><label class="flabel">Aim & Goal</label><textarea id="mPA" rows="2" placeholder="What are you trying to achieve?"></textarea></div>
    <div class="fg">
      <label class="flabel">Status</label>
      <div class="sprow" id="mPSR" style="margin-bottom:0">
        <div class="sp" data-s="planned" onclick="pickSt(this,'p')">Planned</div>
        <div class="sp" data-s="in-progress" onclick="pickSt(this,'p')">In Progress</div>
        <div class="sp" data-s="review" onclick="pickSt(this,'p')">Review</div>
        <div class="sp" data-s="pause" onclick="pickSt(this,'p')">Pause</div>
        <div class="sp" data-s="blocked" onclick="pickSt(this,'p')">Blocked</div>
        <div class="sp" data-s="done" onclick="pickSt(this,'p')">Done</div>
      </div>
    </div>
    <div class="fg">
      <label class="flabel">Color</label>
      <div class="colorrow" id="mCR">
        <div class="cdot sel" data-c="#7c3aed" style="background:#7c3aed" onclick="pickCol(this)"></div>
        <div class="cdot" data-c="#0ea5e9" style="background:#0ea5e9" onclick="pickCol(this)"></div>
        <div class="cdot" data-c="#10b981" style="background:#10b981" onclick="pickCol(this)"></div>
        <div class="cdot" data-c="#f43f5e" style="background:#f43f5e" onclick="pickCol(this)"></div>
        <div class="cdot" data-c="#f59e0b" style="background:#f59e0b" onclick="pickCol(this)"></div>
        <div class="cdot" data-c="#ec4899" style="background:#ec4899" onclick="pickCol(this)"></div>
        <div class="cdot" data-c="#06b6d4" style="background:#06b6d4" onclick="pickCol(this)"></div>
        <div class="cdot" data-c="#a855f7" style="background:#a855f7" onclick="pickCol(this)"></div>
        <div class="cdot" data-c="#84cc16" style="background:#84cc16" onclick="pickCol(this)"></div>
        <div class="cdot" data-c="#f97316" style="background:#f97316" onclick="pickCol(this)"></div>
      </div>
    </div>
    <div style="display:flex;gap:.8rem">
      <div class="fg" style="flex:0 0 90px"><label class="flabel">Icon</label><input type="text" id="mPI" placeholder="üìÅ" maxlength="2"/></div>
      <div class="fg" style="flex:1"><label class="flabel">Deadline</label><input type="date" id="mPDL"/></div>
    </div>
    <div class="mfooter">
      <button class="btnghost" onclick="closeM('pModal')">Cancel</button>
      <button class="btnsave" onclick="saveProj()">Save Project</button>
    </div>
  </div>
</div>

<!-- SUB MODAL -->
<div class="overlay" id="sModal">
  <div class="modal">
    <div class="mtitle">New Sub-Project</div>
    <div class="msub">Add a sub-group under this project.</div>
    <input type="hidden" id="sPar"/>
    <div class="fg"><label class="flabel">Name *</label><input type="text" id="sName" placeholder="e.g. UI Design Phase"/></div>
    <div class="fg"><label class="flabel">Aim / Goal</label><textarea id="sAim" rows="2" placeholder="What does this sub-project target?"></textarea></div>
    <div class="fg"><label class="flabel">What I Did (First Entry)</label><textarea id="sDid" rows="2" placeholder="What have you done so far?"></textarea></div>
    <div class="fg"><label class="flabel">Planning / Next Steps</label><textarea id="sPlan" rows="2" placeholder="How will you go further?"></textarea></div>
    <div class="fg">
      <label class="flabel">Status</label>
      <div class="sprow" id="mSSR" style="margin-bottom:0">
        <div class="sp" data-s="planned" onclick="pickSt(this,'s')">Planned</div>
        <div class="sp" data-s="in-progress" onclick="pickSt(this,'s')">In Progress</div>
        <div class="sp" data-s="review" onclick="pickSt(this,'s')">Review</div>
        <div class="sp" data-s="pause" onclick="pickSt(this,'s')">Pause</div>
        <div class="sp" data-s="blocked" onclick="pickSt(this,'s')">Blocked</div>
        <div class="sp" data-s="done" onclick="pickSt(this,'s')">Done</div>
      </div>
    </div>
    <div class="mfooter">
      <button class="btnghost" onclick="closeM('sModal')">Cancel</button>
      <button class="btnsave" onclick="saveSub()">Save Sub-Project</button>
    </div>
  </div>
</div>

<div class="toasts" id="toasts"></div>
<input type="file" id="impFile" accept=".json" style="display:none" onchange="handleImp(event)"/>

<script>
// STATE
let S={projects:[]};
let filt='all', editId=null, mPS='planned', mSS='planned', mCol='#7c3aed';
let syncT=null, dirty=false;

// BOOT
window.addEventListener('DOMContentLoaded',async()=>{
  document.getElementById('datePill').textContent=new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
  loadLocal(); loadCfUI(); render();
  await autoLoad();
  setInterval(()=>{if(dirty)doSync(true);},30000);
});

// LOCAL
function loadLocal(){
  try{const d=localStorage.getItem('pp3');if(d)S=JSON.parse(d);if(!S.projects)S.projects=[];}
  catch(e){S={projects:[]};}
}
function persist(){localStorage.setItem('pp3',JSON.stringify(S));dirty=true;debounceSync();}
function debounceSync(){if(syncT)clearTimeout(syncT);syncT=setTimeout(()=>doSync(true),2000);}

// CF SYNC
function getCF(){return{url:localStorage.getItem('pp_url')||'',key:localStorage.getItem('pp_key')||''};}
function loadCfUI(){const cf=getCF();document.getElementById('cfUrl').value=cf.url;document.getElementById('cfKey').value=cf.key;setDB(cf.url?'idle':'off');}
async function autoLoad(){
  const cf=getCF();if(!cf.url||!cf.key)return;
  setDB('sync');
  try{
    const r=await fetch(cf.url+'/load',{headers:{'X-Auth-Key':cf.key}});
    if(r.ok){const d=await r.json();if(d.data&&d.data.projects){S=d.data;localStorage.setItem('pp3',JSON.stringify(S));render();setDB('on');toast('‚úì Live data loaded','success');}else setDB('on');}
    else setDB('err');
  }catch(e){setDB('err');}
}
async function doSync(silent=false){
  const cf=getCF();if(!cf.url||!cf.key)return;
  setDB('sync');
  try{
    const r=await fetch(cf.url+'/sync',{method:'POST',headers:{'Content-Type':'application/json','X-Auth-Key':cf.key},body:JSON.stringify({data:S,updated_at:Date.now()})});
    if(r.ok){dirty=false;setDB('on');if(!silent)toast('‚úì Saved to D1','success');}
    else setDB('err');
  }catch(e){setDB('err');}
}
async function connectDB(){
  const url=document.getElementById('cfUrl').value.trim();
  const key=document.getElementById('cfKey').value.trim();
  if(!url){toast('‚ö† Enter Worker URL','warn');return;}
  if(!key){toast('‚ö† Enter API Key','warn');return;}
  localStorage.setItem('pp_url',url);localStorage.setItem('pp_key',key);
  toggleConfig();toast('üîÑ Connecting‚Ä¶','info');
  await autoLoad();
  if(!dirty)await doSync(true);
}
function setDB(s){
  const d=document.getElementById('dbDot'),l=document.getElementById('dbLbl');
  d.className='db-dot';
  if(s==='on'){d.classList.add('on');l.textContent='Synced';}
  else if(s==='sync'){d.classList.add('sync');l.textContent='Syncing‚Ä¶';}
  else if(s==='err'){d.classList.add('err');l.textContent='DB Error';}
  else if(s==='idle'){l.textContent='DB Ready';}
  else{l.textContent='Setup DB';}
}

// RENDER
function render(){updateStats();renderProjects();}
function updateStats(){
  const ps=S.projects,subs=ps.reduce((a,p)=>a+(p.subs?p.subs.length:0),0);
  document.getElementById('sT').textContent=ps.length;
  document.getElementById('sSubs').textContent=subs+' sub-projects';
  document.getElementById('sP').textContent=ps.filter(p=>p.status==='in-progress').length;
  document.getElementById('sD').textContent=ps.filter(p=>p.status==='done').length;
  document.getElementById('sPa').textContent=ps.filter(p=>p.status==='pause').length;
  document.getElementById('sBl').textContent=ps.filter(p=>p.status==='blocked').length;
}
function renderProjects(){
  const el=document.getElementById('pList');
  const list=filt==='all'?S.projects:S.projects.filter(p=>p.status===filt);
  if(!list.length){
    el.innerHTML=`<div class="empty"><div class="empty-icon">üìÅ</div><div class="empty-title">${filt==='all'?'No projects yet':'No '+filt+' projects'}</div><div class="empty-sub">Create your first project to start tracking progress.</div><button class="btn-new" onclick="openModal('project')" style="border-radius:var(--rsm);margin:0 auto">+ New Project</button></div>`;
    return;
  }
  el.innerHTML=list.map(p=>pCard(p)).join('');
}

function pCard(p){
  const subs=p.subs||[];
  const pct=subs.length?Math.round(subs.filter(s=>s.status==='done').length/subs.length*100):(p.status==='done'?100:0);
  const C=2*Math.PI*23, off=C-(pct/100)*C;
  const col=p.color||'#7c3aed',icon=p.icon||'üìÅ';
  const done=subs.filter(s=>s.status==='done').length;
  return`<div class="pcard" id="pc-${p.id}" style="--pc:${col}">
<div class="phead" onclick="togP('${p.id}')">
  <div class="paccent" style="background:${col};box-shadow:0 0 10px ${col}80"></div>
  <div class="picon">${icon}</div>
  <div class="pinfo">
    <div class="pname">${esc(p.name)}</div>
    <div class="pmeta">
      <div class="sbadge s-${p.status}"><div class="sdot"></div>${p.status.replace('-',' ')}</div>
      <span class="pmi">üì¶ ${subs.length}</span>
      <span class="pmi">‚úì ${done}/${subs.length}</span>
      ${p.deadline?`<span class="pmi">üìÖ ${p.deadline}</span>`:''}
    </div>
  </div>
  <div class="arcwrap"><svg width="54" height="54" viewBox="0 0 54 54"><circle class="arc-bg" cx="27" cy="27" r="23"/><circle class="arc-fill" cx="27" cy="27" r="23" stroke="${col}" stroke-dasharray="${C}" stroke-dashoffset="${off}"/></svg><div class="arcpct">${pct}%</div></div>
  <div class="pactions" onclick="event.stopPropagation()">
    <button class="ibtn" onclick="openModal('project','${p.id}')" title="Edit">‚úé</button>
    <button class="ibtn del" onclick="delP('${p.id}')" title="Delete">‚úï</button>
  </div>
  <div class="chev" id="chev-${p.id}">‚ñæ</div>
</div>
<div class="pbody" id="pb-${p.id}">
  <div style="margin-top:1rem"><div class="slbl" style="margin-bottom:.5rem">Project Status</div>
  <div class="sprow">${['planned','in-progress','review','pause','blocked','done'].map(s=>`<div class="sp ${p.status===s?'on':''}" data-s="${s}" onclick="setPSt('${p.id}','${s}')">${s.replace('-',' ')}</div>`).join('')}</div></div>
  ${p.desc||p.aim?`<div class="igrid" style="margin-top:1rem">
    ${p.desc?`<div class="iblk"><div class="iblk-lbl">Description</div><textarea onblur="updP('${p.id}','desc',this.value)">${esc(p.desc)}</textarea></div>`:''}
    ${p.aim?`<div class="iblk"><div class="iblk-lbl">Aim & Goal</div><textarea onblur="updP('${p.id}','aim',this.value)">${esc(p.aim)}</textarea></div>`:''}
  </div>`:''}
  <div class="srow" style="margin-top:1.2rem"><span class="slbl">Sub-Projects (${subs.length})</span><button class="btnsub" onclick="openModal('sub','${p.id}')">+ Add Sub-Project</button></div>
  <div class="subslist" id="sl-${p.id}">${subs.length?subs.map(s=>sCard(p.id,s,col)).join(''):'<div style="color:var(--muted);font-size:.78rem;padding:.4rem 0">No sub-projects yet.</div>'}</div>
</div></div>`;
}

function sCard(pid,sub,col){
  const tasks=sub.tasks||[],log=sub.log||[],doneT=tasks.filter(t=>t.done).length;
  return`<div class="subcard" id="sc-${sub.id}">
<div class="subhead" onclick="togS('${sub.id}')">
  <div class="subdot" style="background:${col};box-shadow:0 0 7px ${col}80"></div>
  <div class="subinfo"><div class="subname">${esc(sub.name)}</div><div class="subprev">${sub.aim?esc(sub.aim):'No aim set yet'}</div></div>
  <div style="display:flex;gap:.4rem;align-items:center" onclick="event.stopPropagation()">
    <div class="sbadge s-${sub.status}" style="font-size:.6rem"><div class="sdot"></div>${sub.status.replace('-',' ')}</div>
    ${tasks.length?`<span style="font-size:.65rem;color:var(--muted);font-family:'JetBrains Mono',monospace">${doneT}/${tasks.length}</span>`:''}
    <button class="ibtn del" style="width:28px;height:28px;font-size:.75rem" onclick="delS('${pid}','${sub.id}')">‚úï</button>
  </div>
  <div class="chev" id="sc-${sub.id}-ch">‚ñæ</div>
</div>
<div class="subbody" id="sb-${sub.id}">
  <div class="sprow" style="margin-bottom:.9rem">${['planned','in-progress','review','pause','blocked','done'].map(s=>`<div class="sp ${sub.status===s?'on':''}" data-s="${s}" onclick="setSSt('${pid}','${sub.id}','${s}')">${s.replace('-',' ')}</div>`).join('')}</div>
  <div class="sgrid">
    <div class="sfield"><label>Aim / Goal</label><textarea onblur="updS('${pid}','${sub.id}','aim',this.value)" placeholder="What are you targeting?">${esc(sub.aim||'')}</textarea></div>
    <div class="sfield"><label>Planning / Next Steps</label><textarea onblur="updS('${pid}','${sub.id}','plan',this.value)" placeholder="How will you go further?">${esc(sub.plan||'')}</textarea></div>
  </div>
  <div class="taskwrap"><div class="slbl" style="margin-bottom:.5rem">‚úÖ Tasks</div><div id="tl-${sub.id}"></div>
  <div class="addrow"><input type="text" id="ti-${sub.id}" placeholder="Add task‚Ä¶ press Enter" onkeydown="if(event.key==='Enter')addTask('${pid}','${sub.id}')"/><button class="btnadd" onclick="addTask('${pid}','${sub.id}')">+ Add</button></div></div>
  <div><div class="slbl" style="margin-bottom:.5rem">üìù Activity Log</div><div id="ll-${sub.id}"></div>
  <div class="loginrow"><textarea id="li-${sub.id}" placeholder="Today's update‚Ä¶ Ctrl+Enter to save"></textarea><button class="btnadd" style="height:fit-content;padding:.55rem .8rem" onclick="addLog('${pid}','${sub.id}')">+ Log</button></div></div>
</div></div>`;
}

// TOGGLE
function togP(id){
  const b=document.getElementById('pb-'+id),c=document.getElementById('chev-'+id);
  const open=b.classList.toggle('open');c.classList.toggle('open',open);
  if(open){const p=S.projects.find(x=>x.id===id);if(p&&p.subs)p.subs.forEach(s=>{rTasks(s.id,s.tasks||[]);rLog(s.id,s.log||[],id);});}
}
function togS(id){document.getElementById('sb-'+id).classList.toggle('open');document.getElementById('sc-'+id+'-ch').classList.toggle('open');}

// CRUD PROJECTS
function openModal(type,id){
  if(type==='project'){
    editId=id&&S.projects.find(x=>x.id===id)?id:null;
    if(editId){
      const p=S.projects.find(x=>x.id===id);
      document.getElementById('mPN').value=p.name;document.getElementById('mPD').value=p.desc||'';
      document.getElementById('mPA').value=p.aim||'';document.getElementById('mPDL').value=p.deadline||'';
      document.getElementById('mPI').value=p.icon||'üìÅ';mCol=p.color||'#7c3aed';mPS=p.status||'planned';
      document.getElementById('mT').textContent='Edit Project';document.getElementById('mS').textContent='Update project details.';
    }else{
      ['mPN','mPD','mPA'].forEach(i=>document.getElementById(i).value='');
      document.getElementById('mPI').value='üìÅ';document.getElementById('mPDL').value='';
      mCol='#7c3aed';mPS='planned';document.getElementById('mT').textContent='New Project';
      document.getElementById('mS').textContent='Fill in the details to create a new project.';
    }
    syncPills('mPSR',mPS);syncCols();document.getElementById('pModal').classList.add('open');
  }else{
    document.getElementById('sPar').value=id;
    ['sName','sAim','sDid','sPlan'].forEach(i=>document.getElementById(i).value='');
    mSS='planned';syncPills('mSSR',mSS);document.getElementById('sModal').classList.add('open');
  }
}
function closeM(id){document.getElementById(id).classList.remove('open');}
function saveProj(){
  const name=document.getElementById('mPN').value.trim();if(!name){toast('‚ö† Name required','warn');return;}
  if(editId){
    const p=S.projects.find(x=>x.id===editId);
    if(p){p.name=name;p.desc=document.getElementById('mPD').value.trim();p.aim=document.getElementById('mPA').value.trim();p.deadline=document.getElementById('mPDL').value;p.status=mPS;p.color=mCol;p.icon=document.getElementById('mPI').value.trim()||'üìÅ';p.u=now();}
  }else{
    S.projects.push({id:uid(),name,desc:document.getElementById('mPD').value.trim(),aim:document.getElementById('mPA').value.trim(),deadline:document.getElementById('mPDL').value,status:mPS,color:mCol,icon:document.getElementById('mPI').value.trim()||'üìÅ',subs:[],c:now(),u:now()});
  }
  persist();closeM('pModal');render();toast('‚úì Project saved','success');
}
function delP(id){if(!confirm('Delete project?'))return;S.projects=S.projects.filter(p=>p.id!==id);persist();render();toast('üóë Deleted');}
function setPSt(pid,s){const p=S.projects.find(x=>x.id===pid);if(p){p.status=s;p.u=now();persist();render();toast('‚Üí '+s);}}
function updP(pid,f,v){const p=S.projects.find(x=>x.id===pid);if(p){p[f]=v;p.u=now();persist();}}

// CRUD SUBS
function saveSub(){
  const pid=document.getElementById('sPar').value,name=document.getElementById('sName').value.trim();
  if(!name){toast('‚ö† Name required','warn');return;}
  const p=S.projects.find(x=>x.id===pid);if(!p)return;
  const did=document.getElementById('sDid').value.trim();
  const sub={id:uid(),name,aim:document.getElementById('sAim').value.trim(),plan:document.getElementById('sPlan').value.trim(),status:mSS,tasks:[],log:[],c:now(),u:now()};
  if(did)sub.log.push({id:uid(),date:today(),text:did});
  p.subs.push(sub);p.u=now();persist();closeM('sModal');render();toast('‚úì Sub-project added','success');
}
function delS(pid,sid){if(!confirm('Delete sub-project?'))return;const p=S.projects.find(x=>x.id===pid);if(p){p.subs=p.subs.filter(s=>s.id!==sid);p.u=now();}persist();render();toast('üóë Deleted');}
function setSSt(pid,sid,s){const p=S.projects.find(x=>x.id===pid);if(!p)return;const sub=p.subs.find(x=>x.id===sid);if(sub){sub.status=s;sub.u=now();}persist();render();toast('‚Üí '+s);}
function updS(pid,sid,f,v){const p=S.projects.find(x=>x.id===pid);if(!p)return;const sub=p.subs.find(x=>x.id===sid);if(sub){sub[f]=v;sub.u=now();persist();}}

// TASKS
function addTask(pid,sid){
  const inp=document.getElementById('ti-'+sid),text=inp.value.trim();if(!text)return;
  const sub=findSub(pid,sid);if(!sub.tasks)sub.tasks=[];
  sub.tasks.push({id:uid(),text,done:false});inp.value='';persist();rTasks(sid,sub.tasks);toast('‚úì Task added');
}
function togTask(pid,sid,tid){const sub=findSub(pid,sid);const t=sub.tasks.find(x=>x.id===tid);if(t)t.done=!t.done;persist();rTasks(sid,sub.tasks);}
function delTask(pid,sid,tid){const sub=findSub(pid,sid);sub.tasks=sub.tasks.filter(t=>t.id!==tid);persist();rTasks(sid,sub.tasks);}
function rTasks(sid,tasks){
  const el=document.getElementById('tl-'+sid);if(!el)return;
  const pid=findPid(sid);
  if(!tasks||!tasks.length){el.innerHTML='<div style="color:var(--muted);font-size:.75rem;padding:.3rem .6rem">No tasks yet.</div>';return;}
  el.innerHTML=tasks.map(t=>`<div class="titem"><div class="tcheck ${t.done?'done':''}" onclick="togTask('${pid}','${sid}','${t.id}')">${t.done?'‚úì':''}</div><span class="ttext ${t.done?'done':''}">${esc(t.text)}</span><button class="tdel" onclick="delTask('${pid}','${sid}','${t.id}')">‚úï</button></div>`).join('');
}

// LOG
function addLog(pid,sid){
  const ta=document.getElementById('li-'+sid),text=ta.value.trim();if(!text)return;
  const sub=findSub(pid,sid);if(!sub.log)sub.log=[];
  sub.log.push({id:uid(),date:today(),text});ta.value='';persist();rLog(sid,sub.log,pid);toast('‚úì Logged');
}
function delLog(pid,sid,lid){const sub=findSub(pid,sid);sub.log=sub.log.filter(l=>l.id!==lid);persist();rLog(sid,sub.log,pid);}
function rLog(sid,log,pid){
  const el=document.getElementById('ll-'+sid);if(!el)return;
  const p=pid||findPid(sid);
  if(!log||!log.length){el.innerHTML='<div style="color:var(--muted);font-size:.75rem;padding:.3rem .6rem">No entries yet.</div>';return;}
  el.innerHTML=[...log].reverse().map(l=>`<div class="lentry"><span class="ldate">${l.date}</span><span class="ltext">${esc(l.text)}</span><button class="ldel" onclick="delLog('${p}','${sid}','${l.id}')">‚úï</button></div>`).join('');
}

// FILTER & VIEW
function doFilter(f,btn){filt=f;document.querySelectorAll('.fchip').forEach(b=>b.classList.remove('active'));btn.classList.add('active');render();}
function switchView(v,btn){document.querySelectorAll('.vpill').forEach(b=>b.classList.remove('active'));document.querySelectorAll('.vp').forEach(p=>p.classList.remove('active'));btn.classList.add('active');document.getElementById(v+'-panel').classList.add('active');}

// MODAL HELPERS
function pickSt(el,t){const r=t==='p'?'mPSR':'mSSR';document.getElementById(r).querySelectorAll('.sp').forEach(s=>s.classList.remove('on'));el.classList.add('on');if(t==='p')mPS=el.dataset.s;else mSS=el.dataset.s;}
function syncPills(rowId,s){document.getElementById(rowId).querySelectorAll('.sp').forEach(p=>p.classList.toggle('on',p.dataset.s===s));}
function pickCol(el){mCol=el.dataset.c;syncCols();}
function syncCols(){document.querySelectorAll('.cdot').forEach(d=>d.classList.toggle('sel',d.dataset.c===mCol));}

// REPORT
function genReport(){
  const fmt=document.getElementById('rFmt').value;
  const date=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  let out='';
  if(fmt==='md'){
    out=`# üìä ProjectPulse Report\n**Date:** ${date} | **Projects:** ${S.projects.length}\n\n---\n\n`;
    S.projects.forEach(p=>{
      const pct=p.subs&&p.subs.length?Math.round(p.subs.filter(s=>s.status==='done').length/p.subs.length*100):(p.status==='done'?100:0);
      out+=`## ${p.icon||'üìÅ'} ${p.name} ‚Äî \`${p.status}\` ${pct}%\n`;
      if(p.aim)out+=`> **Goal:** ${p.aim}\n\n`;
      if(p.subs&&p.subs.length)p.subs.forEach(s=>{
        out+=`### ‚Ü≥ ${s.name} [\`${s.status}\`]\n`;
        if(s.aim)out+=`**Aim:** ${s.aim}\n`;
        if(s.plan)out+=`**Plan:** ${s.plan}\n`;
        if(s.log&&s.log.length){out+=`**Updates:**\n`;s.log.slice(-3).forEach(l=>out+=`- \`${l.date}\` ${l.text}\n`);}
        if(s.tasks&&s.tasks.length){const d=s.tasks.filter(t=>t.done).length;out+=`**Tasks:** ${d}/${s.tasks.length}\n`;}
        out+='\n';
      });
      out+='---\n\n';
    });
  }else{
    out=`PROJECT STATUS REPORT ‚Äî ${date}\n${'‚ïê'.repeat(55)}\n\n`;
    S.projects.forEach(p=>{
      const pct=p.subs&&p.subs.length?Math.round(p.subs.filter(s=>s.status==='done').length/p.subs.length*100):0;
      out+=`[${p.status.toUpperCase()}] ${p.name} ‚Äî ${pct}%\n`;
      if(p.aim)out+=`  Goal: ${p.aim}\n`;
      if(p.subs&&p.subs.length)p.subs.forEach(s=>out+=`  >> ${s.name} [${s.status}]${s.plan?' ‚Äî '+s.plan:''}\n`);
      out+='\n';
    });
  }
  document.getElementById('rOut').textContent=out;toast('‚úì Report ready','success');
}
function copyReport(){navigator.clipboard.writeText(document.getElementById('rOut').textContent).then(()=>toast('‚úì Copied!','success'));}

// IMPORT/EXPORT
function doExport(){const b=new Blob([JSON.stringify(S,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`projectpulse-${today()}.json`;a.click();toast('‚úì Exported');}
function doImport(){document.getElementById('impFile').click();}
function handleImp(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.projects){S=d;persist();render();toast('‚úì Imported','success');}}catch(e){toast('‚úó Invalid file','error');}};r.readAsText(f);e.target.value='';}

// UTILS
function toggleConfig(){document.getElementById('cfgDrawer').classList.toggle('open');}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6);}
function now(){return new Date().toISOString();}
function today(){return new Date().toISOString().slice(0,10);}
function esc(s){if(!s)return'';return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function findPid(sid){for(const p of S.projects)if(p.subs&&p.subs.find(s=>s.id===sid))return p.id;return'';}
function findSub(pid,sid){const p=S.projects.find(x=>x.id===pid);return p?p.subs.find(s=>s.id===sid):null;}

function toast(msg,type='info'){
  const c=document.getElementById('toasts'),el=document.createElement('div');
  el.className='toast '+(type||'');
  const ic={success:'‚úÖ',error:'‚ùå',warn:'‚ö†Ô∏è',info:'üí¨'};
  el.innerHTML=`<span>${ic[type]||'üí¨'}</span><span>${msg}</span>`;
  c.appendChild(el);setTimeout(()=>el.remove(),3200);
}

document.querySelectorAll('.overlay').forEach(o=>{o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');});});
document.addEventListener('click',e=>{
  const dr=document.getElementById('cfgDrawer'),btn=document.querySelector('.db-btn');
  if(dr.classList.contains('open')&&!dr.contains(e.target)&&!btn.contains(e.target))dr.classList.remove('open');
});
</script>
</body>
</html>
