<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ProjectPulse ‚Äî Daily Progress Manager</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@300;400;600&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #18181f;
    --border: #2a2a38;
    --border2: #3a3a50;
    --text: #e8e8f0;
    --muted: #6b6b85;
    --accent: #6c63ff;
    --accent2: #a78bfa;
    --green: #22c55e;
    --yellow: #eab308;
    --orange: #f97316;
    --red: #ef4444;
    --blue: #3b82f6;
    --cyan: #06b6d4;
    --pink: #ec4899;
    --radius: 12px;
    --radius-sm: 8px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Noise texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 9999;
    opacity: 0.3;
  }

  /* HEADER */
  header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(10,10,15,0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 64px;
  }

  .logo {
    font-family: 'DM Serif Display', serif;
    font-size: 1.5rem;
    color: var(--text);
    letter-spacing: -0.02em;
  }

  .logo span {
    color: var(--accent2);
    font-style: italic;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .date-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 0.3rem 0.75rem;
    border-radius: 100px;
  }

  .sync-btn {
    background: var(--accent);
    color: white;
    border: none;
    padding: 0.45rem 1rem;
    border-radius: 100px;
    font-family: 'Syne', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .sync-btn:hover { background: var(--accent2); transform: translateY(-1px); }

  .sync-btn.syncing { animation: pulse-glow 1s infinite; }

  @keyframes pulse-glow {
    0%,100% { box-shadow: 0 0 0 0 rgba(108,99,255,0.4); }
    50% { box-shadow: 0 0 0 8px rgba(108,99,255,0); }
  }

  /* LAYOUT */
  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  /* STATS BAR */
  .stats-bar {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
    animation: fadeUp 0.5s ease both;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.2rem 1.4rem;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--accent-color, var(--accent));
  }

  .stat-card:hover { border-color: var(--border2); }

  .stat-label {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
    margin-bottom: 0.4rem;
  }

  .stat-value {
    font-family: 'DM Serif Display', serif;
    font-size: 2.2rem;
    line-height: 1;
    color: var(--accent-color, var(--text));
  }

  /* TOOLBAR */
  .toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    gap: 1rem;
    flex-wrap: wrap;
    animation: fadeUp 0.5s 0.1s ease both;
  }

  .toolbar-left {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .filter-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.4rem 0.9rem;
    border-radius: 100px;
    font-size: 0.78rem;
    font-family: 'Syne', sans-serif;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }

  .filter-btn:hover, .filter-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none;
    color: white;
    padding: 0.5rem 1.2rem;
    border-radius: var(--radius-sm);
    font-family: 'Syne', sans-serif;
    font-size: 0.82rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(108,99,255,0.4); }

  /* PROJECTS GRID */
  .projects-grid {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    animation: fadeUp 0.5s 0.2s ease both;
  }

  /* PROJECT CARD */
  .project-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    transition: border-color 0.3s, box-shadow 0.3s;
  }

  .project-card:hover {
    border-color: var(--border2);
    box-shadow: 0 4px 30px rgba(0,0,0,0.4);
  }

  .project-header {
    padding: 1.4rem 1.6rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    cursor: pointer;
    user-select: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s;
    position: relative;
  }

  .project-header.expanded {
    border-bottom-color: var(--border);
  }

  .project-color-bar {
    width: 4px;
    height: 40px;
    border-radius: 4px;
    flex-shrink: 0;
  }

  .project-info {
    flex: 1;
    min-width: 0;
  }

  .project-name {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.2rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .project-meta {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    display: flex;
    gap: 1rem;
  }

  .project-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  .progress-ring {
    width: 48px;
    height: 48px;
    position: relative;
    flex-shrink: 0;
  }

  .progress-ring svg {
    transform: rotate(-90deg);
  }

  .progress-ring .bg { fill: none; stroke: var(--border2); stroke-width: 3; }
  .progress-ring .fill { fill: none; stroke-width: 3; stroke-linecap: round; transition: stroke-dashoffset 0.6s ease; }

  .progress-pct {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.6rem;
    font-weight: 600;
    color: var(--text);
  }

  .chevron {
    color: var(--muted);
    transition: transform 0.3s;
    font-size: 1.2rem;
    line-height: 1;
  }

  .chevron.open { transform: rotate(180deg); }

  .icon-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    width: 32px;
    height: 32px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    transition: all 0.2s;
  }

  .icon-btn:hover { background: var(--surface2); color: var(--text); border-color: var(--border2); }
  .icon-btn.danger:hover { background: rgba(239,68,68,0.1); color: var(--red); border-color: var(--red); }

  /* PROJECT BODY */
  .project-body {
    display: none;
    padding: 1.4rem 1.6rem;
    border-top: 1px solid var(--border);
  }

  .project-body.open { display: block; }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .section-title {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
  }

  /* SUBPROJECT */
  .subprojects {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .subproject-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .subproject-card:hover { border-color: var(--border2); }

  .subproject-header {
    padding: 0.9rem 1.1rem;
    display: flex;
    align-items: center;
    gap: 0.8rem;
    cursor: pointer;
  }

  .subproject-info { flex: 1; min-width: 0; }

  .subproject-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.15rem;
  }

  .subproject-aim {
    font-size: 0.75rem;
    color: var(--muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .subproject-body {
    display: none;
    padding: 1rem 1.1rem;
    border-top: 1px solid var(--border);
  }

  .subproject-body.open { display: block; }

  /* DETAIL SECTIONS */
  .detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .detail-block {
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 0.8rem 1rem;
  }

  .detail-block-label {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
    margin-bottom: 0.4rem;
    font-weight: 700;
  }

  .detail-block-value {
    font-size: 0.82rem;
    color: var(--text);
    line-height: 1.5;
  }

  textarea, input[type="text"], input[type="date"] {
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    font-size: 0.82rem;
    padding: 0.6rem 0.8rem;
    border-radius: var(--radius-sm);
    width: 100%;
    resize: vertical;
    transition: border-color 0.2s;
    outline: none;
  }

  textarea:focus, input:focus { border-color: var(--accent); }

  /* STATUS PILLS */
  .status-group {
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
  }

  .status-pill {
    padding: 0.3rem 0.7rem;
    border-radius: 100px;
    font-size: 0.7rem;
    font-weight: 700;
    border: 1.5px solid transparent;
    cursor: pointer;
    transition: all 0.15s;
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .status-pill[data-status="in-progress"] { border-color: var(--blue); color: var(--blue); }
  .status-pill[data-status="in-progress"].active { background: var(--blue); color: white; }
  .status-pill[data-status="done"] { border-color: var(--green); color: var(--green); }
  .status-pill[data-status="done"].active { background: var(--green); color: white; }
  .status-pill[data-status="pause"] { border-color: var(--yellow); color: var(--yellow); }
  .status-pill[data-status="pause"].active { background: var(--yellow); color: #000; }
  .status-pill[data-status="review"] { border-color: var(--cyan); color: var(--cyan); }
  .status-pill[data-status="review"].active { background: var(--cyan); color: #000; }
  .status-pill[data-status="blocked"] { border-color: var(--red); color: var(--red); }
  .status-pill[data-status="blocked"].active { background: var(--red); color: white; }
  .status-pill[data-status="planned"] { border-color: var(--muted); color: var(--muted); }
  .status-pill[data-status="planned"].active { background: var(--muted); color: white; }

  /* ACTIVITY LOG */
  .activity-log {
    margin-top: 0.8rem;
  }

  .log-entry {
    display: flex;
    gap: 0.8rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .log-date {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    white-space: nowrap;
    padding-top: 0.15rem;
    min-width: 70px;
  }

  .log-text {
    font-size: 0.78rem;
    color: var(--text);
    line-height: 1.5;
    flex: 1;
  }

  .log-delete {
    color: var(--muted);
    cursor: pointer;
    font-size: 0.8rem;
    padding: 0.1rem 0.3rem;
    border-radius: 4px;
    transition: all 0.2s;
    background: transparent;
    border: none;
  }

  .log-delete:hover { color: var(--red); background: rgba(239,68,68,0.1); }

  /* ADD LOG */
  .add-log-row {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.8rem;
    align-items: flex-start;
  }

  .add-log-row textarea {
    min-height: 60px;
    resize: none;
  }

  .btn-sm {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.5rem 0.8rem;
    border-radius: var(--radius-sm);
    font-family: 'Syne', sans-serif;
    font-size: 0.75rem;
    font-weight: 700;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
    height: fit-content;
  }

  .btn-sm:hover { background: var(--surface2); border-color: var(--border2); }
  .btn-sm.success { border-color: var(--green); color: var(--green); }
  .btn-sm.success:hover { background: rgba(34,197,94,0.1); }

  /* SUBGROUP TASKS */
  .tasks-list {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    margin-top: 0.5rem;
  }

  .task-item {
    display: flex;
    align-items: center;
    gap: 0.7rem;
    padding: 0.5rem 0.7rem;
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    border-radius: 6px;
    transition: all 0.2s;
  }

  .task-item:hover { border-color: var(--border2); }

  .task-check {
    width: 16px;
    height: 16px;
    border: 1.5px solid var(--border2);
    border-radius: 4px;
    flex-shrink: 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .task-check.checked {
    background: var(--green);
    border-color: var(--green);
    color: white;
    font-size: 0.65rem;
  }

  .task-text {
    flex: 1;
    font-size: 0.78rem;
    color: var(--text);
  }

  .task-text.done {
    text-decoration: line-through;
    color: var(--muted);
  }

  /* MODAL */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }

  .modal-overlay.open {
    opacity: 1;
    pointer-events: all;
  }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: var(--radius);
    width: 100%;
    max-width: 520px;
    padding: 2rem;
    transform: translateY(20px) scale(0.98);
    transition: transform 0.25s;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-overlay.open .modal {
    transform: translateY(0) scale(1);
  }

  .modal-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    color: var(--text);
  }

  .form-group {
    margin-bottom: 1.1rem;
  }

  .form-label {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
    margin-bottom: 0.4rem;
    display: block;
  }

  .color-picker {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .color-dot {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.15s;
  }

  .color-dot.selected {
    border-color: white;
    transform: scale(1.2);
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.7rem;
    margin-top: 1.5rem;
  }

  .btn-cancel {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.6rem 1.2rem;
    border-radius: var(--radius-sm);
    font-family: 'Syne', sans-serif;
    font-size: 0.82rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-cancel:hover { border-color: var(--border2); color: var(--text); }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 5rem 2rem;
    color: var(--muted);
  }

  .empty-icon {
    font-size: 3.5rem;
    margin-bottom: 1rem;
    opacity: 0.3;
  }

  .empty-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.5rem;
    color: var(--text);
    margin-bottom: 0.5rem;
  }

  .empty-sub {
    font-size: 0.85rem;
    margin-bottom: 2rem;
  }

  /* TOAST */
  .toast-container {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 9000;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .toast {
    background: var(--surface2);
    border: 1px solid var(--border2);
    color: var(--text);
    padding: 0.8rem 1.2rem;
    border-radius: var(--radius-sm);
    font-size: 0.82rem;
    display: flex;
    align-items: center;
    gap: 0.6rem;
    animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
    min-width: 220px;
  }

  @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  @keyframes fadeOut { to { opacity: 0; transform: translateX(10px); } }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

  /* Status indicator in project header */
  .status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .status-indicator.in-progress { background: var(--blue); box-shadow: 0 0 6px var(--blue); animation: blink 2s infinite; }
  .status-indicator.done { background: var(--green); }
  .status-indicator.pause { background: var(--yellow); }
  .status-indicator.review { background: var(--cyan); }
  .status-indicator.blocked { background: var(--red); }
  .status-indicator.planned { background: var(--muted); }

  @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

  /* REPORT VIEW */
  .report-bar {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.5rem;
  }

  .view-tab {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--muted);
    padding: 0.5rem;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-family: 'Syne', sans-serif;
    font-size: 0.8rem;
    font-weight: 700;
    transition: all 0.2s;
  }

  .view-tab.active { background: var(--accent); color: white; }

  .view-panel { display: none; }
  .view-panel.active { display: block; }

  /* Report output */
  .report-output {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 2rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.78rem;
    line-height: 1.8;
    color: var(--text);
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 500px;
    overflow-y: auto;
  }

  /* API CONFIG */
  .api-config {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.2rem;
    margin-bottom: 1.5rem;
    display: none;
  }

  .api-config.open { display: block; }

  .api-config-title {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.8rem;
  }

  .api-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.7rem;
  }

  @media (max-width: 768px) {
    .stats-bar { grid-template-columns: repeat(2, 1fr); }
    .detail-grid { grid-template-columns: 1fr; }
    .api-grid { grid-template-columns: 1fr; }
    .project-header { flex-wrap: wrap; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">Project<span>Pulse</span></div>
  <div class="header-right">
    <div class="date-badge" id="currentDate"></div>
    <button class="sync-btn" onclick="toggleApiConfig()" title="Configure Cloudflare D1">‚öô API</button>
    <button class="sync-btn" id="syncBtn" onclick="syncToCloudflare()">‚Üë Sync</button>
  </div>
</header>

<div class="container">

  <!-- API CONFIG -->
  <div class="api-config" id="apiConfig">
    <div class="api-config-title">‚òÅ Cloudflare D1 Configuration</div>
    <div class="api-grid">
      <div>
        <label class="form-label">Worker URL</label>
        <input type="text" id="cfWorkerUrl" placeholder="https://your-worker.workers.dev" />
      </div>
      <div>
        <label class="form-label">API Key (X-Auth-Key)</label>
        <input type="text" id="cfApiKey" placeholder="your-secret-key" />
      </div>
      <div>
        <label class="form-label">Account ID</label>
        <input type="text" id="cfAccountId" placeholder="Cloudflare Account ID" />
      </div>
      <div>
        <label class="form-label">Database ID</label>
        <input type="text" id="cfDatabaseId" placeholder="D1 Database ID" />
      </div>
    </div>
    <div style="margin-top:0.8rem; display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
      <button class="btn-sm success" onclick="saveApiConfig()">‚úì Save Config</button>
      <button class="btn-sm" onclick="loadFromCloudflare()">‚Üì Load from D1</button>
      <button class="btn-sm" onclick="exportData()">‚¨á Export JSON</button>
      <button class="btn-sm" onclick="importData()">‚¨Ü Import JSON</button>
      <span style="font-size:0.7rem; color:var(--muted); margin-left:auto;">Data auto-saves to localStorage</span>
    </div>
    <div style="margin-top:0.8rem; background:rgba(0,0,0,0.3); border-radius:6px; padding:0.8rem; font-family:'JetBrains Mono',monospace; font-size:0.65rem; color:var(--muted); line-height:1.7;">
      <strong style="color:var(--accent2);">Worker schema (deploy to Cloudflare Workers):</strong><br>
      ‚Ä¢ POST /sync ‚Äî body: {data: JSON} ‚Äî saves entire state<br>
      ‚Ä¢ GET /load ‚Äî returns saved state JSON<br>
      ‚Ä¢ Header: X-Auth-Key: your-secret-key<br>
      <br>
      <strong style="color:var(--accent2);">D1 SQL init:</strong><br>
      CREATE TABLE IF NOT EXISTS projects (id TEXT PRIMARY KEY, data TEXT, updated_at INTEGER);<br>
      <br>
      <a href="#" onclick="downloadWorkerScript(); return false;" style="color:var(--accent2);">‚¨á Download Worker Script</a>
    </div>
  </div>

  <!-- STATS -->
  <div class="stats-bar" id="statsBar">
    <div class="stat-card" style="--accent-color: var(--accent2)">
      <div class="stat-label">Total Projects</div>
      <div class="stat-value" id="statTotal">0</div>
    </div>
    <div class="stat-card" style="--accent-color: var(--blue)">
      <div class="stat-label">In Progress</div>
      <div class="stat-value" id="statProgress">0</div>
    </div>
    <div class="stat-card" style="--accent-color: var(--green)">
      <div class="stat-label">Done</div>
      <div class="stat-value" id="statDone">0</div>
    </div>
    <div class="stat-card" style="--accent-color: var(--yellow)">
      <div class="stat-label">Paused</div>
      <div class="stat-value" id="statPause">0</div>
    </div>
    <div class="stat-card" style="--accent-color: var(--red)">
      <div class="stat-label">Blocked</div>
      <div class="stat-value" id="statBlocked">0</div>
    </div>
  </div>

  <!-- VIEW TABS -->
  <div class="report-bar">
    <button class="view-tab active" onclick="switchView('projects', this)">üìÅ Projects</button>
    <button class="view-tab" onclick="switchView('report', this)">üìä Team Report</button>
  </div>

  <!-- PROJECTS VIEW -->
  <div id="projects-panel" class="view-panel active">
    <!-- TOOLBAR -->
    <div class="toolbar">
      <div class="toolbar-left">
        <button class="filter-btn active" onclick="filterProjects('all', this)">All</button>
        <button class="filter-btn" onclick="filterProjects('in-progress', this)">üîµ In Progress</button>
        <button class="filter-btn" onclick="filterProjects('done', this)">üü¢ Done</button>
        <button class="filter-btn" onclick="filterProjects('pause', this)">üü° Paused</button>
        <button class="filter-btn" onclick="filterProjects('blocked', this)">üî¥ Blocked</button>
        <button class="filter-btn" onclick="filterProjects('review', this)">ü©µ Review</button>
        <button class="filter-btn" onclick="filterProjects('planned', this)">‚ö™ Planned</button>
      </div>
      <button class="btn-primary" onclick="openModal('project')">+ New Project</button>
    </div>

    <div class="projects-grid" id="projectsGrid"></div>
  </div>

  <!-- REPORT VIEW -->
  <div id="report-panel" class="view-panel">
    <div style="display:flex; gap:0.7rem; margin-bottom:1rem; flex-wrap:wrap;">
      <button class="btn-primary" onclick="generateReport()">‚ö° Generate Report</button>
      <button class="btn-sm" onclick="copyReport()">üìã Copy</button>
      <select id="reportFormat" style="background:var(--surface);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.8rem;border-radius:var(--radius-sm);font-family:'Syne',sans-serif;font-size:0.8rem;">
        <option value="markdown">Markdown</option>
        <option value="plain">Plain Text</option>
        <option value="html">HTML</option>
      </select>
    </div>
    <div class="report-output" id="reportOutput">Click "Generate Report" to create a team-ready status report.</div>
  </div>

</div>

<!-- PROJECT MODAL -->
<div class="modal-overlay" id="projectModal">
  <div class="modal">
    <div class="modal-title" id="modalTitle">New Project</div>
    <div class="form-group">
      <label class="form-label">Project Name *</label>
      <input type="text" id="inputProjectName" placeholder="e.g. Website Redesign" />
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <textarea id="inputProjectDesc" rows="2" placeholder="What is this project about?"></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Overall Aim / Goal</label>
      <textarea id="inputProjectAim" rows="2" placeholder="What are you trying to achieve?"></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Status</label>
      <div class="status-group" id="modalProjectStatus">
        <div class="status-pill" data-status="planned" onclick="selectModalStatus(this, 'project')">Planned</div>
        <div class="status-pill" data-status="in-progress" onclick="selectModalStatus(this, 'project')">In Progress</div>
        <div class="status-pill" data-status="review" onclick="selectModalStatus(this, 'project')">Review</div>
        <div class="status-pill" data-status="pause" onclick="selectModalStatus(this, 'project')">Pause</div>
        <div class="status-pill" data-status="blocked" onclick="selectModalStatus(this, 'project')">Blocked</div>
        <div class="status-pill" data-status="done" onclick="selectModalStatus(this, 'project')">Done</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Color</label>
      <div class="color-picker" id="colorPicker">
        <div class="color-dot selected" style="background:#6c63ff" data-color="#6c63ff" onclick="selectColor(this)"></div>
        <div class="color-dot" style="background:#22c55e" data-color="#22c55e" onclick="selectColor(this)"></div>
        <div class="color-dot" style="background:#3b82f6" data-color="#3b82f6" onclick="selectColor(this)"></div>
        <div class="color-dot" style="background:#ec4899" data-color="#ec4899" onclick="selectColor(this)"></div>
        <div class="color-dot" style="background:#f97316" data-color="#f97316" onclick="selectColor(this)"></div>
        <div class="color-dot" style="background:#eab308" data-color="#eab308" onclick="selectColor(this)"></div>
        <div class="color-dot" style="background:#06b6d4" data-color="#06b6d4" onclick="selectColor(this)"></div>
        <div class="color-dot" style="background:#ef4444" data-color="#ef4444" onclick="selectColor(this)"></div>
        <div class="color-dot" style="background:#a78bfa" data-color="#a78bfa" onclick="selectColor(this)"></div>
        <div class="color-dot" style="background:#14b8a6" data-color="#14b8a6" onclick="selectColor(this)"></div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Deadline</label>
      <input type="date" id="inputProjectDeadline" />
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('project')">Cancel</button>
      <button class="btn-primary" onclick="saveProject()">Save Project</button>
    </div>
  </div>
</div>

<!-- SUBPROJECT MODAL -->
<div class="modal-overlay" id="subprojectModal">
  <div class="modal">
    <div class="modal-title">New Sub-Project</div>
    <input type="hidden" id="subProjectParentId" />
    <div class="form-group">
      <label class="form-label">Sub-Project Name *</label>
      <input type="text" id="inputSubName" placeholder="e.g. UI Design Phase" />
    </div>
    <div class="form-group">
      <label class="form-label">Aim / Goal</label>
      <textarea id="inputSubAim" rows="2" placeholder="What does this sub-project aim to achieve?"></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">What I Did (Initial Update)</label>
      <textarea id="inputSubDid" rows="2" placeholder="What have you done so far?"></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Planning / Next Steps</label>
      <textarea id="inputSubPlan" rows="2" placeholder="How are you planning to go further?"></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Status</label>
      <div class="status-group" id="modalSubStatus">
        <div class="status-pill" data-status="planned" onclick="selectModalStatus(this, 'sub')">Planned</div>
        <div class="status-pill" data-status="in-progress" onclick="selectModalStatus(this, 'sub')">In Progress</div>
        <div class="status-pill" data-status="review" onclick="selectModalStatus(this, 'sub')">Review</div>
        <div class="status-pill" data-status="pause" onclick="selectModalStatus(this, 'sub')">Pause</div>
        <div class="status-pill" data-status="blocked" onclick="selectModalStatus(this, 'sub')">Blocked</div>
        <div class="status-pill" data-status="done" onclick="selectModalStatus(this, 'sub')">Done</div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('subproject')">Cancel</button>
      <button class="btn-primary" onclick="saveSubProject()">Save Sub-Project</button>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<input type="file" id="importFileInput" accept=".json" style="display:none" onchange="handleImport(event)" />

<script>
// =====================
// STATE
// =====================
let state = {
  projects: [],
  lastSync: null
};

let modalProjectStatus = 'planned';
let modalSubStatus = 'planned';
let selectedColor = '#6c63ff';
let currentFilter = 'all';
let editingProjectId = null;

// =====================
// INIT
// =====================
document.addEventListener('DOMContentLoaded', () => {
  updateDate();
  loadState();
  loadApiConfigUI();
  render();
});

function updateDate() {
  const d = new Date();
  document.getElementById('currentDate').textContent =
    d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric', year:'numeric' });
}

// =====================
// STATE PERSISTENCE
// =====================
function loadState() {
  try {
    const saved = localStorage.getItem('projectpulse_state');
    if (saved) state = JSON.parse(saved);
    if (!state.projects) state.projects = [];
  } catch(e) { state = { projects: [] }; }
}

function saveState() {
  localStorage.setItem('projectpulse_state', JSON.stringify(state));
}

function loadApiConfigUI() {
  document.getElementById('cfWorkerUrl').value = localStorage.getItem('cf_worker_url') || '';
  document.getElementById('cfApiKey').value = localStorage.getItem('cf_api_key') || '';
  document.getElementById('cfAccountId').value = localStorage.getItem('cf_account_id') || '';
  document.getElementById('cfDatabaseId').value = localStorage.getItem('cf_database_id') || '';
}

function saveApiConfig() {
  localStorage.setItem('cf_worker_url', document.getElementById('cfWorkerUrl').value);
  localStorage.setItem('cf_api_key', document.getElementById('cfApiKey').value);
  localStorage.setItem('cf_account_id', document.getElementById('cfAccountId').value);
  localStorage.setItem('cf_database_id', document.getElementById('cfDatabaseId').value);
  toast('‚úì API config saved', 'success');
}

// =====================
// CLOUDFLARE SYNC
// =====================
async function syncToCloudflare() {
  const workerUrl = localStorage.getItem('cf_worker_url');
  const apiKey = localStorage.getItem('cf_api_key');
  if (!workerUrl) { toast('‚ö† Configure Worker URL first', 'warn'); toggleApiConfig(); return; }
  const btn = document.getElementById('syncBtn');
  btn.classList.add('syncing');
  btn.textContent = '‚Üë Syncing...';
  try {
    const res = await fetch(workerUrl + '/sync', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Auth-Key': apiKey || '' },
      body: JSON.stringify({ data: state, updated_at: Date.now() })
    });
    if (res.ok) {
      state.lastSync = new Date().toISOString();
      saveState();
      toast('‚úì Synced to Cloudflare D1', 'success');
    } else { toast('‚úó Sync failed: ' + res.status, 'error'); }
  } catch(e) {
    // Fallback: save locally
    saveState();
    toast('‚ö† Saved locally (Worker offline)', 'warn');
  }
  btn.classList.remove('syncing');
  btn.textContent = '‚Üë Sync';
}

async function loadFromCloudflare() {
  const workerUrl = localStorage.getItem('cf_worker_url');
  const apiKey = localStorage.getItem('cf_api_key');
  if (!workerUrl) { toast('‚ö† Configure Worker URL first', 'warn'); return; }
  try {
    const res = await fetch(workerUrl + '/load', {
      headers: { 'X-Auth-Key': apiKey || '' }
    });
    if (res.ok) {
      const remote = await res.json();
      if (remote.data) {
        state = remote.data;
        saveState();
        render();
        toast('‚úì Loaded from Cloudflare D1', 'success');
      }
    } else { toast('‚úó Load failed: ' + res.status, 'error'); }
  } catch(e) { toast('‚úó Could not reach Worker', 'error'); }
}

// =====================
// ID GEN
// =====================
function genId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
}

// =====================
// MODAL
// =====================
function openModal(type, parentId, editId) {
  if (type === 'project') {
    editingProjectId = editId || null;
    const modal = document.getElementById('projectModal');
    if (editId) {
      const p = state.projects.find(x => x.id === editId);
      if (p) {
        document.getElementById('inputProjectName').value = p.name;
        document.getElementById('inputProjectDesc').value = p.description || '';
        document.getElementById('inputProjectAim').value = p.aim || '';
        document.getElementById('inputProjectDeadline').value = p.deadline || '';
        selectedColor = p.color || '#6c63ff';
        modalProjectStatus = p.status || 'planned';
        document.getElementById('modalTitle').textContent = 'Edit Project';
        updateColorPicker();
      }
    } else {
      document.getElementById('inputProjectName').value = '';
      document.getElementById('inputProjectDesc').value = '';
      document.getElementById('inputProjectAim').value = '';
      document.getElementById('inputProjectDeadline').value = '';
      selectedColor = '#6c63ff';
      modalProjectStatus = 'planned';
      document.getElementById('modalTitle').textContent = 'New Project';
      updateColorPicker();
    }
    updateModalStatusPills('project');
    modal.classList.add('open');
  } else if (type === 'subproject') {
    document.getElementById('subProjectParentId').value = parentId;
    document.getElementById('inputSubName').value = '';
    document.getElementById('inputSubAim').value = '';
    document.getElementById('inputSubDid').value = '';
    document.getElementById('inputSubPlan').value = '';
    modalSubStatus = 'planned';
    updateModalStatusPills('sub');
    document.getElementById('subprojectModal').classList.add('open');
  }
}

function closeModal(type) {
  if (type === 'project') document.getElementById('projectModal').classList.remove('open');
  if (type === 'subproject') document.getElementById('subprojectModal').classList.remove('open');
}

function selectModalStatus(el, type) {
  const group = type === 'project' ? 'modalProjectStatus' : 'modalSubStatus';
  document.getElementById(group).querySelectorAll('.status-pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  if (type === 'project') modalProjectStatus = el.dataset.status;
  else modalSubStatus = el.dataset.status;
}

function updateModalStatusPills(type) {
  const group = type === 'project' ? 'modalProjectStatus' : 'modalSubStatus';
  const status = type === 'project' ? modalProjectStatus : modalSubStatus;
  document.getElementById(group).querySelectorAll('.status-pill').forEach(p => {
    p.classList.toggle('active', p.dataset.status === status);
  });
}

function selectColor(el) {
  selectedColor = el.dataset.color;
  updateColorPicker();
}

function updateColorPicker() {
  document.querySelectorAll('.color-dot').forEach(d => {
    d.classList.toggle('selected', d.dataset.color === selectedColor);
  });
}

// =====================
// SAVE PROJECT
// =====================
function saveProject() {
  const name = document.getElementById('inputProjectName').value.trim();
  if (!name) { toast('‚ö† Project name is required', 'warn'); return; }
  if (editingProjectId) {
    const p = state.projects.find(x => x.id === editingProjectId);
    if (p) {
      p.name = name;
      p.description = document.getElementById('inputProjectDesc').value.trim();
      p.aim = document.getElementById('inputProjectAim').value.trim();
      p.deadline = document.getElementById('inputProjectDeadline').value;
      p.status = modalProjectStatus;
      p.color = selectedColor;
      p.updatedAt = new Date().toISOString();
    }
  } else {
    state.projects.push({
      id: genId(),
      name,
      description: document.getElementById('inputProjectDesc').value.trim(),
      aim: document.getElementById('inputProjectAim').value.trim(),
      deadline: document.getElementById('inputProjectDeadline').value,
      status: modalProjectStatus,
      color: selectedColor,
      subprojects: [],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    });
  }
  saveState();
  closeModal('project');
  render();
  toast('‚úì Project saved', 'success');
}

function deleteProject(id) {
  if (!confirm('Delete this project and all sub-projects?')) return;
  state.projects = state.projects.filter(p => p.id !== id);
  saveState();
  render();
  toast('üóë Project deleted');
}

// =====================
// SAVE SUBPROJECT
// =====================
function saveSubProject() {
  const parentId = document.getElementById('subProjectParentId').value;
  const name = document.getElementById('inputSubName').value.trim();
  if (!name) { toast('‚ö† Sub-project name is required', 'warn'); return; }
  const parent = state.projects.find(p => p.id === parentId);
  if (!parent) return;
  const didText = document.getElementById('inputSubDid').value.trim();
  const sub = {
    id: genId(),
    name,
    aim: document.getElementById('inputSubAim').value.trim(),
    plan: document.getElementById('inputSubPlan').value.trim(),
    status: modalSubStatus,
    tasks: [],
    log: [],
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  if (didText) {
    sub.log.push({ id: genId(), date: todayStr(), text: didText });
  }
  parent.subprojects.push(sub);
  parent.updatedAt = new Date().toISOString();
  saveState();
  closeModal('subproject');
  render();
  toast('‚úì Sub-project added', 'success');
}

function deleteSubProject(projectId, subId) {
  if (!confirm('Delete this sub-project?')) return;
  const p = state.projects.find(x => x.id === projectId);
  if (p) p.subprojects = p.subprojects.filter(s => s.id !== subId);
  saveState();
  render();
  toast('üóë Sub-project deleted');
}

// =====================
// STATUS
// =====================
function setSubStatus(projectId, subId, status) {
  const p = state.projects.find(x => x.id === projectId);
  if (!p) return;
  const sub = p.subprojects.find(s => s.id === subId);
  if (!sub) return;
  sub.status = status;
  sub.updatedAt = new Date().toISOString();
  updateProjectProgress(p);
  saveState();
  render();
  toast('Status updated ‚Üí ' + status);
}

function setProjectStatus(projectId, status) {
  const p = state.projects.find(x => x.id === projectId);
  if (!p) return;
  p.status = status;
  p.updatedAt = new Date().toISOString();
  saveState();
  render();
  toast('Status updated ‚Üí ' + status);
}

function updateProjectProgress(project) {
  if (!project.subprojects.length) return;
  const done = project.subprojects.filter(s => s.status === 'done').length;
  // status auto-update hint
}

// =====================
// LOG
// =====================
function addLog(projectId, subId) {
  const ta = document.getElementById(`log-input-${subId}`);
  const text = ta.value.trim();
  if (!text) return;
  const p = state.projects.find(x => x.id === projectId);
  const sub = p.subprojects.find(s => s.id === subId);
  sub.log.push({ id: genId(), date: todayStr(), text });
  sub.updatedAt = new Date().toISOString();
  ta.value = '';
  saveState();
  renderSubLog(subId, sub.log, projectId);
  toast('‚úì Log entry added');
}

function deleteLog(projectId, subId, logId) {
  const p = state.projects.find(x => x.id === projectId);
  const sub = p.subprojects.find(s => s.id === subId);
  sub.log = sub.log.filter(l => l.id !== logId);
  saveState();
  renderSubLog(subId, sub.log, projectId);
}

function renderSubLog(subId, log, projectId) {
  const el = document.getElementById(`log-list-${subId}`);
  if (!el) return;
  if (!log.length) {
    el.innerHTML = '<div style="color:var(--muted);font-size:0.75rem;padding:0.5rem 0;">No entries yet.</div>';
    return;
  }
  el.innerHTML = [...log].reverse().map(l => `
    <div class="log-entry">
      <span class="log-date">${l.date}</span>
      <span class="log-text">${escHtml(l.text)}</span>
      <button class="log-delete" onclick="deleteLog('${projectId}','${subId}','${l.id}')" title="Remove">‚úï</button>
    </div>
  `).join('');
}

// =====================
// TASKS
// =====================
function addTask(projectId, subId) {
  const ta = document.getElementById(`task-input-${subId}`);
  const text = ta.value.trim();
  if (!text) return;
  const p = state.projects.find(x => x.id === projectId);
  const sub = p.subprojects.find(s => s.id === subId);
  if (!sub.tasks) sub.tasks = [];
  sub.tasks.push({ id: genId(), text, done: false });
  ta.value = '';
  saveState();
  renderTasks(subId, sub.tasks, projectId);
}

function toggleTask(projectId, subId, taskId) {
  const p = state.projects.find(x => x.id === projectId);
  const sub = p.subprojects.find(s => s.id === subId);
  const task = sub.tasks.find(t => t.id === taskId);
  if (task) task.done = !task.done;
  saveState();
  renderTasks(subId, sub.tasks, projectId);
}

function deleteTask(projectId, subId, taskId) {
  const p = state.projects.find(x => x.id === projectId);
  const sub = p.subprojects.find(s => s.id === subId);
  sub.tasks = sub.tasks.filter(t => t.id !== taskId);
  saveState();
  renderTasks(subId, sub.tasks, projectId);
}

function renderTasks(subId, tasks, projectId) {
  const el = document.getElementById(`tasks-list-${subId}`);
  if (!el) return;
  if (!tasks || !tasks.length) {
    el.innerHTML = '<div style="color:var(--muted);font-size:0.75rem;padding:0.4rem 0;">No tasks yet.</div>';
    return;
  }
  el.innerHTML = tasks.map(t => `
    <div class="task-item">
      <div class="task-check ${t.done ? 'checked' : ''}" onclick="toggleTask('${projectId}','${subId}','${t.id}')">
        ${t.done ? '‚úì' : ''}
      </div>
      <span class="task-text ${t.done ? 'done' : ''}">${escHtml(t.text)}</span>
      <button class="log-delete" onclick="deleteTask('${projectId}','${subId}','${t.id}')" title="Delete">‚úï</button>
    </div>
  `).join('');
}

// =====================
// INLINE EDIT
// =====================
function updateSubField(projectId, subId, field) {
  const el = document.getElementById(`${field}-${subId}`);
  if (!el) return;
  const p = state.projects.find(x => x.id === projectId);
  const sub = p.subprojects.find(s => s.id === subId);
  sub[field] = el.value;
  sub.updatedAt = new Date().toISOString();
  saveState();
}

// =====================
// FILTER
// =====================
function filterProjects(status, btn) {
  currentFilter = status;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  render();
}

// =====================
// RENDER
// =====================
function render() {
  updateStats();
  renderProjects();
}

function updateStats() {
  const ps = state.projects;
  document.getElementById('statTotal').textContent = ps.length;
  document.getElementById('statProgress').textContent = ps.filter(p => p.status === 'in-progress').length;
  document.getElementById('statDone').textContent = ps.filter(p => p.status === 'done').length;
  document.getElementById('statPause').textContent = ps.filter(p => p.status === 'pause').length;
  document.getElementById('statBlocked').textContent = ps.filter(p => p.status === 'blocked').length;
}

function calcProgress(project) {
  if (!project.subprojects || !project.subprojects.length) {
    return project.status === 'done' ? 100 : 0;
  }
  const done = project.subprojects.filter(s => s.status === 'done').length;
  return Math.round((done / project.subprojects.length) * 100);
}

function renderProjects() {
  const grid = document.getElementById('projectsGrid');
  const filtered = currentFilter === 'all'
    ? state.projects
    : state.projects.filter(p => p.status === currentFilter);

  if (!filtered.length) {
    grid.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üìÅ</div>
        <div class="empty-title">${currentFilter === 'all' ? 'No projects yet' : 'No ' + currentFilter + ' projects'}</div>
        <div class="empty-sub">Create your first project to get started tracking progress.</div>
        <button class="btn-primary" onclick="openModal('project')" style="margin:0 auto">+ New Project</button>
      </div>
    `;
    return;
  }

  grid.innerHTML = filtered.map(p => renderProjectCard(p)).join('');
}

function renderProjectCard(p) {
  const pct = calcProgress(p);
  const circumference = 2 * Math.PI * 20;
  const dashOffset = circumference - (pct / 100) * circumference;
  const subCount = p.subprojects ? p.subprojects.length : 0;
  const doneCount = p.subprojects ? p.subprojects.filter(s => s.status === 'done').length : 0;

  return `
    <div class="project-card" id="proj-${p.id}">
      <div class="project-header" id="ph-${p.id}" onclick="toggleProject('${p.id}')">
        <div class="project-color-bar" style="background:${p.color}"></div>
        <div class="status-indicator ${p.status}"></div>
        <div class="project-info">
          <div class="project-name">${escHtml(p.name)}</div>
          <div class="project-meta">
            <span>${subCount} sub-projects</span>
            <span>${doneCount}/${subCount} done</span>
            ${p.deadline ? `<span>üìÖ ${p.deadline}</span>` : ''}
            <span>${p.status}</span>
          </div>
        </div>
        <div class="project-actions" onclick="event.stopPropagation()">
          <div class="progress-ring">
            <svg width="48" height="48" viewBox="0 0 48 48">
              <circle class="bg" cx="24" cy="24" r="20"/>
              <circle class="fill" cx="24" cy="24" r="20"
                stroke="${p.color}"
                stroke-dasharray="${circumference}"
                stroke-dashoffset="${dashOffset}"/>
            </svg>
            <div class="progress-pct">${pct}%</div>
          </div>
          <button class="icon-btn" onclick="openModal('project', null, '${p.id}')" title="Edit">‚úé</button>
          <button class="icon-btn danger" onclick="deleteProject('${p.id}')" title="Delete">‚úï</button>
        </div>
        <div class="chevron" id="chev-${p.id}">‚ñæ</div>
      </div>

      <div class="project-body" id="pb-${p.id}">
        <!-- Project Status Bar -->
        <div style="margin-bottom:1.2rem;">
          <div class="section-title" style="margin-bottom:0.5rem;">Project Status</div>
          <div class="status-group">
            ${['planned','in-progress','review','pause','blocked','done'].map(s => `
              <div class="status-pill ${p.status === s ? 'active' : ''}" data-status="${s}" onclick="setProjectStatus('${p.id}','${s}')">${s}</div>
            `).join('')}
          </div>
        </div>

        ${p.description || p.aim ? `
        <div class="detail-grid" style="margin-bottom:1.2rem;">
          ${p.description ? `<div class="detail-block"><div class="detail-block-label">Description</div><div class="detail-block-value">${escHtml(p.description)}</div></div>` : ''}
          ${p.aim ? `<div class="detail-block"><div class="detail-block-label">Aim & Goal</div><div class="detail-block-value">${escHtml(p.aim)}</div></div>` : ''}
        </div>` : ''}

        <!-- Sub-Projects -->
        <div class="section-header">
          <span class="section-title">Sub-Projects (${subCount})</span>
          <button class="btn-sm" onclick="openModal('subproject', '${p.id}')">+ Add Sub-Project</button>
        </div>

        <div class="subprojects">
          ${p.subprojects && p.subprojects.length
            ? p.subprojects.map(sub => renderSubProject(p.id, sub)).join('')
            : `<div style="color:var(--muted);font-size:0.8rem;padding:0.5rem 0;">No sub-projects yet. Add one above.</div>`
          }
        </div>
      </div>
    </div>
  `;
}

function renderSubProject(projectId, sub) {
  return `
    <div class="subproject-card" id="sub-${sub.id}">
      <div class="subproject-header" onclick="toggleSub('${sub.id}')">
        <div class="status-indicator ${sub.status}"></div>
        <div class="subproject-info">
          <div class="subproject-name">${escHtml(sub.name)}</div>
          ${sub.aim ? `<div class="subproject-aim">${escHtml(sub.aim)}</div>` : ''}
        </div>
        <div style="display:flex;gap:0.4rem;align-items:center;" onclick="event.stopPropagation()">
          <button class="icon-btn danger" onclick="deleteSubProject('${projectId}','${sub.id}')" title="Delete">‚úï</button>
        </div>
        <div class="chevron" id="subchev-${sub.id}">‚ñæ</div>
      </div>

      <div class="subproject-body" id="sb-${sub.id}">
        <!-- Status -->
        <div style="margin-bottom:1rem;">
          <div class="section-title" style="margin-bottom:0.4rem;">Status</div>
          <div class="status-group">
            ${['planned','in-progress','review','pause','blocked','done'].map(s => `
              <div class="status-pill ${sub.status === s ? 'active' : ''}" data-status="${s}"
                onclick="setSubStatus('${projectId}','${sub.id}','${s}')">${s}</div>
            `).join('')}
          </div>
        </div>

        <!-- Aim & Plan -->
        <div class="detail-grid" style="margin-bottom:1rem;">
          <div class="detail-block">
            <div class="detail-block-label">Aim / Goal</div>
            <textarea id="aim-${sub.id}" style="min-height:60px;"
              onblur="updateSubField('${projectId}','${sub.id}','aim')"
              placeholder="What is this sub-project aiming for?">${escHtml(sub.aim || '')}</textarea>
          </div>
          <div class="detail-block">
            <div class="detail-block-label">Planning / Next Steps</div>
            <textarea id="plan-${sub.id}" style="min-height:60px;"
              onblur="updateSubField('${projectId}','${sub.id}','plan')"
              placeholder="How are you planning to go further?">${escHtml(sub.plan || '')}</textarea>
          </div>
        </div>

        <!-- Tasks / Checklist -->
        <div style="margin-bottom:1rem;">
          <div class="section-header">
            <span class="section-title">Tasks / Checklist</span>
          </div>
          <div class="tasks-list" id="tasks-list-${sub.id}"></div>
          <div class="add-log-row" style="margin-top:0.6rem;">
            <input type="text" id="task-input-${sub.id}" placeholder="Add a task..."
              onkeydown="if(event.key==='Enter') addTask('${projectId}','${sub.id}')" />
            <button class="btn-sm success" onclick="addTask('${projectId}','${sub.id}')">+ Add</button>
          </div>
        </div>

        <!-- Activity Log -->
        <div>
          <div class="section-header">
            <span class="section-title">Activity Log (What I Did)</span>
          </div>
          <div class="activity-log">
            <div id="log-list-${sub.id}"></div>
            <div class="add-log-row">
              <textarea id="log-input-${sub.id}" placeholder="What did you do today? Write your update..."
                onkeydown="if(event.key==='Enter' && event.ctrlKey) addLog('${projectId}','${sub.id}')"></textarea>
              <button class="btn-sm success" onclick="addLog('${projectId}','${sub.id}')">+ Log</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// =====================
// TOGGLE COLLAPSE
// =====================
function toggleProject(id) {
  const body = document.getElementById(`pb-${id}`);
  const chev = document.getElementById(`chev-${id}`);
  const header = document.getElementById(`ph-${id}`);
  const isOpen = body.classList.contains('open');
  body.classList.toggle('open');
  chev.classList.toggle('open');
  header.classList.toggle('expanded');
  if (!isOpen) {
    // render sub-content after expand
    const p = state.projects.find(x => x.id === id);
    if (p && p.subprojects) {
      p.subprojects.forEach(sub => {
        renderSubLog(sub.id, sub.log || [], id);
        renderTasks(sub.id, sub.tasks || [], id);
      });
    }
  }
}

function toggleSub(subId) {
  const body = document.getElementById(`sb-${subId}`);
  const chev = document.getElementById(`subchev-${subId}`);
  body.classList.toggle('open');
  chev.classList.toggle('open');
}

// =====================
// VIEW SWITCH
// =====================
function switchView(view, btn) {
  document.querySelectorAll('.view-tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.view-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(view + '-panel').classList.add('active');
}

// =====================
// REPORT
// =====================
function generateReport() {
  const format = document.getElementById('reportFormat').value;
  const date = new Date().toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  let out = '';

  if (format === 'markdown') {
    out = `# üìä Project Status Report\n**Date:** ${date}\n\n`;
    state.projects.forEach(p => {
      const pct = calcProgress(p);
      out += `## ${p.name} [${p.status.toUpperCase()}] ‚Äî ${pct}% complete\n`;
      if (p.description) out += `> ${p.description}\n`;
      if (p.aim) out += `**Aim:** ${p.aim}\n`;
      out += '\n';
      if (p.subprojects && p.subprojects.length) {
        p.subprojects.forEach(sub => {
          out += `### ‚Ü≥ ${sub.name} [${sub.status.toUpperCase()}]\n`;
          if (sub.aim) out += `**Aim:** ${sub.aim}\n`;
          if (sub.plan) out += `**Plan:** ${sub.plan}\n`;
          if (sub.log && sub.log.length) {
            out += `**Recent Activity:**\n`;
            sub.log.slice(-3).forEach(l => { out += `- [${l.date}] ${l.text}\n`; });
          }
          if (sub.tasks && sub.tasks.length) {
            const done = sub.tasks.filter(t => t.done).length;
            out += `**Tasks:** ${done}/${sub.tasks.length} done\n`;
          }
          out += '\n';
        });
      }
      out += '---\n\n';
    });
  } else if (format === 'plain') {
    out = `PROJECT STATUS REPORT ‚Äî ${date}\n${'='.repeat(50)}\n\n`;
    state.projects.forEach(p => {
      const pct = calcProgress(p);
      out += `[${p.status.toUpperCase()}] ${p.name} ‚Äî ${pct}% complete\n`;
      if (p.aim) out += `  Aim: ${p.aim}\n`;
      if (p.subprojects && p.subprojects.length) {
        p.subprojects.forEach(sub => {
          out += `  >> ${sub.name} [${sub.status.toUpperCase()}]\n`;
          if (sub.plan) out += `     Plan: ${sub.plan}\n`;
          if (sub.log && sub.log.length) {
            out += `     Latest: ${sub.log[sub.log.length-1].text}\n`;
          }
        });
      }
      out += '\n';
    });
  } else {
    out = `<h1>üìä Project Status Report</h1><p><strong>Date:</strong> ${date}</p>`;
    state.projects.forEach(p => {
      const pct = calcProgress(p);
      out += `<h2>${escHtml(p.name)} <span style="color:gray">[${p.status}]</span></h2>`;
      out += `<p>Progress: <strong>${pct}%</strong></p>`;
      if (p.aim) out += `<p><strong>Aim:</strong> ${escHtml(p.aim)}</p>`;
      if (p.subprojects && p.subprojects.length) {
        out += '<ul>';
        p.subprojects.forEach(sub => {
          out += `<li><strong>${escHtml(sub.name)}</strong> [${sub.status}]`;
          if (sub.plan) out += ` ‚Äî ${escHtml(sub.plan)}`;
          out += '</li>';
        });
        out += '</ul>';
      }
    });
  }

  document.getElementById('reportOutput').textContent = out;
  toast('‚úì Report generated');
}

function copyReport() {
  const text = document.getElementById('reportOutput').textContent;
  navigator.clipboard.writeText(text).then(() => toast('‚úì Copied to clipboard'));
}

// =====================
// IMPORT/EXPORT
// =====================
function exportData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `projectpulse-${todayStr()}.json`;
  a.click();
  toast('‚úì Exported JSON');
}

function importData() {
  document.getElementById('importFileInput').click();
}

function handleImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const imported = JSON.parse(ev.target.result);
      if (imported.projects) {
        state = imported;
        saveState();
        render();
        toast('‚úì Data imported successfully');
      }
    } catch(err) { toast('‚úó Invalid JSON file', 'error'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

// =====================
// WORKER SCRIPT DOWNLOAD
// =====================
function downloadWorkerScript() {
  const script = `// Cloudflare Worker + D1 for ProjectPulse
export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    const authKey = request.headers.get('X-Auth-Key');
    const SECRET = env.AUTH_KEY || 'your-secret-key';

    if (authKey !== SECRET) {
      return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401,
        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' }
      });
    }

    const cors = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, X-Auth-Key',
      'Content-Type': 'application/json'
    };

    if (request.method === 'OPTIONS') return new Response(null, { headers: cors });

    // Init DB
    await env.DB.exec(\`CREATE TABLE IF NOT EXISTS projects (id TEXT PRIMARY KEY, data TEXT, updated_at INTEGER);\`);

    if (url.pathname === '/sync' && request.method === 'POST') {
      const body = await request.json();
      await env.DB.prepare('INSERT OR REPLACE INTO projects (id, data, updated_at) VALUES (?, ?, ?)')
        .bind('main', JSON.stringify(body.data), Date.now()).run();
      return new Response(JSON.stringify({ ok: true }), { headers: cors });
    }

    if (url.pathname === '/load') {
      const row = await env.DB.prepare('SELECT data FROM projects WHERE id = ?').bind('main').first();
      if (row) return new Response(JSON.stringify({ data: JSON.parse(row.data) }), { headers: cors });
      return new Response(JSON.stringify({ data: null }), { headers: cors });
    }

    return new Response(JSON.stringify({ error: 'Not found' }), { status: 404, headers: cors });
  }
};
`;
  const blob = new Blob([script], { type: 'text/javascript' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'projectpulse-worker.js';
  a.click();
  toast('‚úì Worker script downloaded');
}

// =====================
// UTILS
// =====================
function toggleApiConfig() {
  document.getElementById('apiConfig').classList.toggle('open');
}

function todayStr() {
  return new Date().toISOString().slice(0, 10);
}

function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function toast(msg, type = 'info') {
  const c = document.getElementById('toastContainer');
  const el = document.createElement('div');
  el.className = 'toast';
  const icons = { success: '‚úì', error: '‚úó', warn: '‚ö†', info: '‚Ñπ' };
  el.innerHTML = `<span>${icons[type] || '‚Ñπ'}</span><span>${msg}</span>`;
  if (type === 'success') el.style.borderColor = 'var(--green)';
  if (type === 'error') el.style.borderColor = 'var(--red)';
  if (type === 'warn') el.style.borderColor = 'var(--yellow)';
  c.appendChild(el);
  setTimeout(() => el.remove(), 3200);
}

// Close modals on backdrop click
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => {
    if (e.target === o) {
      o.classList.remove('open');
    }
  });
});
</script>
</body>
</html>
`;
